---
sidebar: sidebar 
permalink: migration/shift-toolkit-migrate-esxi2olvm.html 
keywords: netapp, vmware, esxi, vm, migration, virtualization, oracle, linux, olvm 
summary: Shift Toolkit を使用して VM を準備し、ディスク形式を変換し、ターゲット環境を構成することで、VM を VMware ESXi から Oracle Linux Virtualization Manager に移行します。 
---
= VMware ESXiからOracle Linux Virtualization ManagerへのVMの移行
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Shift Toolkit を使用して VM を準備し、ディスク形式を変換し、ターゲット環境を構成することで、VM を VMware ESXi から Oracle Linux Virtualization Manager (OLVM) に移行します。

Shift Toolkit は、ディスク形式の変換と移行先環境でのネットワーク再構成を通じて、仮想化プラットフォーム間での VM の移行を可能にします。



== 開始する前に

移行を開始する前に、次の前提条件が満たされていることを確認してください。

.Oracle Linux Virtualization Manager の要件
* Oracle Linux Virtualization Manager とデータセンターに追加された Oracle Linux KVM ホスト
* ONTAP NFSストレージがストレージドメインとして追加されました
* クラスターの管理者レベルの権限
* Oracle Linux Virtualization Manager および VDSM リリースは 4.5 以上です
* Oracle Linux Virtualization Manager（宛先）ホストはネットワークで到達可能である
* 適切なボリュームとqtreeで構成されたNFSv3ストレージドメイン
+
** vdsm ユーザー (UID 36) と kvm グループ (GID 36) への読み取り/書き込みアクセスが許可されていることを確認します。


* 適切なVLANで構成されたネットワーク


.VMware の要件
* VM VMDK は NFSv3 ボリューム上に配置されます (特定の VM のすべての VMDK は同じボリュームの一部である必要があります)
* VMwareツールはゲストVM上で実行されています
* 移行対象のVMは準備のため実行状態にあります
* 移行を開始する前にVMの電源をオフにする必要があります
* VMware Tools の削除は、VM の電源がオンになると、対象のハイパーバイザーで実行されます。


.ゲストVMの要件
* Windows VMの場合: ローカル管理者の資格情報を使用する
* Linux VMの場合: パスワードプロンプトなしでsudoコマンドを実行する権限を持つユーザーを使用します
* Windows VMの場合: VirtIO ISOをVMにマウントします（link:https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.271-1/virtio-win-0.1.271.iso["ここをクリックしてください。"] ）
+

NOTE: 準備スクリプトは、.msi パッケージを使用して、ドライバーと qemu-guest-agents をインストールします。





== ステップ1: 宛先サイトを追加する (OLVM)

宛先の Oracle Linux Virtualization Manager 環境を Shift Toolkit に追加します。

.手順
. *新しいサイトを追加*をクリックし、*宛先*を選択します。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-200.png[目的地を選択]

====
. 宛先サイトの詳細を入力します。
+
** *サイト名*: サイトの名前を入力してください
** *ハイパーバイザー*: OLVMを選択
** *サイトの場所*: デフォルトのオプションを選択します
** *コネクタ*: デフォルトの選択を選択します


. *続行*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-201.png[目的地サイトの詳細]

====
. OLVM の詳細を入力します。
+
** *エンドポイント*: 仮想化マネージャーのIPアドレスまたはFQDN
** *ユーザー名*: username@profile 形式のユーザー名 (例: admin@internal)
** *パスワード*: 仮想化マネージャーにアクセスするためのパスワード


. *自己署名証明書を受け入れる*を選択し、*続行*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-202.png[宛先OLVMの詳細]

====
. *サイトの作成*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-203.png[宛先OLVMの作成]

====
+

NOTE: ディスク形式の変換は同じボリューム内のボリューム レベルで行われるため、ソース ボリュームと宛先ボリュームは同じになります。





== ステップ2: リソースグループを作成する

VM をリソース グループに編成して、ブート順序とブート遅延構成を保持します。

.開始する前に
* 前提条件で指定されているとおりにqtreeがプロビジョニングされていることを確認します。
* 変換前に、新しく作成されたONTAP SVM 上の指定されたデータストアに VM を移動し、本番 NFS データストアをステージング領域から分離します。


.手順
. *リソース グループ* に移動し、*新しいリソース グループの作成* をクリックします。
. ドロップダウンからソースサイトを選択し、「作成」をクリックします。
. リソース グループの詳細を入力し、ワークフローを選択します。
+
** *クローンベースの移行*: ソースハイパーバイザーから宛先ハイパーバイザーへのエンドツーエンドの移行を実行します
** *クローンベースの変換*: ディスクフォーマットを選択したハイパーバイザータイプに変換します


. *続行*をクリックします。
. 検索オプションを使用して VM を選択します (デフォルトのフィルターは「データストア」です)。
+

NOTE: データストア ドロップダウンには、NFSv3 データストアのみが表示されます。  NFSv4 データストアは表示されません。

. 移行の詳細を更新します:
+
** *宛先サイト*を選択
** *宛先OLVMエントリ*を選択
** データストアからQtreeへのマッピングを構成する
+
.例を表示
[%collapsible]
====
image::shift-toolkit-204.png[移行の詳細]

====
+

NOTE: VM を ESXi から OLVM に変換するときは、変換先のパス (変換された VM が保存される場所) が qtree に設定されていることを確認します。また、この qtree がストレージ ドメインに追加されていることを確認します。複数の qtree を作成し、変換された VM ディスクの保存に使用できます。



. 選択したすべての VM の起動順序と起動遅延を構成します。
+
** *1*: 最初に電源を入れるVM
** *3*: デフォルト
** *5*: 最後に電源を入れたVM


. *リソース グループの作成*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-205.png[リソース グループの詳細]

====


.結果
リソース グループが作成され、ブループリントの構成の準備が整いました。



== ステップ3: 移行ブループリントを作成する

プラットフォーム マッピング、ネットワーク構成、VM 設定などの移行計画を定義するブループリントを作成します。

.手順
. *ブループリント* に移動し、*新しいブループリントの作成* をクリックします。
. ブループリントの名前を指定し、ホスト マッピングを構成します。
+
** *ソースサイト*と関連するvCenterを選択します
** *宛先サイト*と関連するOLVMターゲットを選択します
** クラスターとホストのマッピングを構成する
+
.例を表示
[%collapsible]
====
image::shift-toolkit-206.png[設計図の詳細]

====


. リソース グループの詳細を選択し、[続行] をクリックします。
. 複数のグループが存在する場合は、リソース グループの実行順序を設定します。
. 適切な論理ネットワークへのネットワーク マッピングを構成します。
+

NOTE: ネットワークは、適切な VLAN タグ付けを使用して OLVM 内にすでにプロビジョニングされている必要があります。テスト移行の場合は、本番ネットワークの競合を避けるために「ネットワークを構成しない」を選択し、変換後にネットワーク設定を手動で割り当てます。

+
.例を表示
[%collapsible]
====
image::shift-toolkit-207.png[ネットワークマッピング]

====
. ストレージ マッピングを確認します (VM の選択に基づいて自動的に選択されます)。
+

NOTE: 仮想マシンを NFS ボリュームから作成してパワーオンできるように、qtree が事前にプロビジョニングされ、必要な権限が割り当てられていることを確認します。

. VM の詳細で、構成の詳細を選択し、各 OS タイプのサービス アカウント資格情報を入力します。
+
** *Windows*: ローカル管理者権限を持つユーザーを使用します (ドメイン資格情報も使用できます)
** *Linux*: パスワードプロンプトなしでsudoコマンドを実行できるユーザーを使用する
+
.例を表示
[%collapsible]
====
image::shift-toolkit-208.png[構成マッピングの詳細]

====
+

NOTE: 構成の選択により、ディスク イメージ形式を選択し、prepareVM のオーバーライドをスキップできます。ワークフローはデフォルトで QCOW2 形式になりますが、必要に応じて RAW 形式を選択することもできます。  override prepareVM オプションを使用すると、管理者は VM の準備をスキップしてカスタム スクリプトを実行できます。



. IP 設定を構成します。
+
** *設定しない*: デフォルトオプション
** *IP を保持*: ソースシステムと同じ IP を保持します
** *DHCP*: ターゲットVMにDHCPを割り当てる
+
prepareVM フェーズ中に VM の電源がオンになっており、VMware Tools がインストールされていることを確認します。



. VM 設定を構成します。
+
** CPU/RAMパラメータのサイズ変更（オプション）
** 起動順序と起動遅延を変更する
** *電源オン*: 移行後にVMの電源をオンにする場合に選択します（デフォルト: オン）
** *VMware ツールを削除*: 変換後に VMware ツールを削除します (デフォルト: 選択)
** *VMファームウェア*: BIOS > BIOSおよびEFI > EFI（自動）
** *MAC アドレスを保持*: ライセンス要件のために MAC アドレスを保持します
** *サービス アカウントのオーバーライド*: 必要に応じて別のサービス アカウントを指定します


. *続行*をクリックします。
. 日時を選択して移行をスケジュールします。
+

NOTE: VM の準備に時間をかけるため、移行は少なくとも 30 分前にスケジュールしてください。

. *ブループリントを作成*をクリックします。


.結果
Shift Toolkit は、移行の準備としてソース VM 上でスクリプトを実行する prepareVM ジョブを開始します。

.例を表示
[%collapsible]
====
image::shift-toolkit-209.png[OLVMの準備の詳細]

====
準備プロセス:

* VirtIO ドライバーの更新、qemu-agent のインストール、VMware ツールの削除、IP の詳細のバックアップ、fstab の更新を行うスクリプトを挿入します。
* PowerCLI を使用してゲスト VM (Linux または Windows) に接続し、VirtIO ドライバーを更新します。
* Windows VMの場合: スクリプトを以下に保存します `C:\NetApp`
* Linux VMの場合: スクリプトを次の場所に保存します `/NetApp`そして `/opt`



NOTE: サポートされている VM OS の場合、Shift Toolkit はディスク変換前に必要な VirtIO ドライバーを自動的にインストールし、変換後の起動が正常に行われるようにします。

prepareVM が正常に完了すると、ブループリントのステータスが「PrepareVM 完了」に更新されます。移行はスケジュールされた時間に実行されるか、[移行] オプションをクリックして手動で開始できます。

.例を表示
[%collapsible]
====
image::shift-toolkit-210.png[移行メニューの選択]

====


== ステップ4: 移行を実行する

移行ワークフローをトリガーして、VM を VMware ESXi から Oracle Linux Virtualization Manager に変換します。

.開始する前に
すべての VM は、計画されたメンテナンス スケジュールに従って正常に電源オフになります。

.手順
. ブループリントで、[移行] をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-211.png[移行手順]

====
. Shift Toolkit は次のアクションを実行します。
+
** ブループリント内のすべてのVMの既存のスナップショットを削除します
** ソースでVMスナップショットをトリガーします
** ディスク変換前にボリュームのスナップショットをトリガーします
** すべてのVMのVMDKをQCOW2またはRAW形式に変換します
+
Shift Toolkit は、プライマリ ブート ディスクを含む、各 VM に関連付けられているすべての VMDK を自動的に検出します。

+

NOTE: VMDK ファイルが複数ある場合は、各 VMDK が変換されます。

** QCOW2またはRAWイメージをOLVMストレージドメインにアップロードします
+
仮想マシンのディスク イメージが QCOW2 または RAW 形式に変換されると、Shift Toolkit はファイルを適切なストレージ ドメインにアップロードし、各ディスクを追加します。

** 仮想マシンを作成する
+
Shift Toolkit は、OS に応じて各 VM を作成するために REST API 呼び出しを行います。

+

NOTE: VM は「Default」クラスターの下に作成されます。

** ターゲットのVMの電源をオンにする
+
VM OS に応じて、Shift Toolkit はストレージ コントローラー インターフェイスとともに VM ブート オプションを自動的に割り当てます。  Linux ディストリビューションの場合、VirtIO または VirtIO SCSI が使用されます。  Windows の場合、VM は SATA インターフェイスで電源をオンにし、スケジュールされたスクリプトによって VirtIO ドライバーが自動的にインストールされ、インターフェイスが VirtIO に変更されます。

** 各VMにネットワークを登録する
+
ネットワークはブループリントの選択に基づいて割り当てられます。

** VMwareツールを削除し、トリガースクリプトまたはcronジョブを使用してIPアドレスを割り当てます




.例を表示
[%collapsible]
====
image::shift-toolkit-212.png[Oracle に移行された VM]

====


== ビデオデモ

次のビデオでは、このソリューションで概説されているプロセスを説明します。

.ESX から Oracle Linux Virtualization Manager (OLVM) へのゼロタッチ移行
video::13bb74ad-25b3-49c0-84b5-b3760100ad6f[panopto]