---
sidebar: sidebar 
permalink: proxmox/proxmox-ontap.html 
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, ontap, storage, aff 
summary: 'Proxmox 仮想環境 (VE) の共有ストレージにより、VM のライブ マイグレーションの時間が短縮され、環境全体でのバックアップや一貫したテンプレートのターゲットが向上します。  ONTAPストレージは、Proxmox VE ホスト環境のニーズだけでなく、ゲスト ファイル、ブロック、オブジェクト ストレージの要求にも対応できます。' 
---
= Proxmox仮想環境用のONTAPストレージのプロビジョニング
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
NAS、SAN、SMB/CIFS プロトコルを使用して、Proxmox 仮想環境 (VE) でONTAPストレージを構成します。  Proxmox VE の共有ストレージにより、ライブ VM の移行にかかる時間が短縮され、環境全体でバックアップのターゲットと一貫したテンプレートがより適切に提供されます。

Proxmox VE ホストには、スイッチにケーブル接続された FC、イーサネット、またはその他のサポートされているインターフェイスがあり、 ONTAP論理インターフェイスと通信できる必要があります。常に確認する https://mysupport.netapp.com/matrix/#welcome["Interoperability Matrix Tool"]サポートされている構成の場合。



== ONTAPの高レベル機能

*共通の特徴*

* スケールアウトクラスタ
* 安全な認証とRBACのサポート
* ゼロトラストマルチ管理者サポート
* 安全なマルチテナンシー
* SnapMirrorを使用してデータを複製します。
* スナップショットによるポイントインタイムコピー。
* スペース効率の高いクローン。
* 重複排除、圧縮などのストレージ効率機能。
* Kubernetes のTrident CSI サポート
* SnapLock
* 改ざん防止スナップショットコピーロック
* 暗号化サポート
* コールド データをオブジェクト ストアに階層化するFabricPool 。
* NetApp ConsoleとData Infrastructure Insights の統合。
* Microsoft オフロード データ転送 (ODX)


*NAS*

* FlexGroupボリュームは、負荷分散とスケーラビリティとともに高いパフォーマンスを提供するスケールアウト NAS コンテナです。
* FlexCache を使用すると、データをグローバルに分散しながらも、データへのローカルの読み取りおよび書き込みアクセスを提供できます。
* マルチプロトコルのサポートにより、NFS だけでなく SMB 経由でも同じデータにアクセスできるようになります。
* NFS nConnect は、TCP 接続ごとに複数の TCP セッションを許可し、ネットワーク スループットを向上させます。これにより、最新のサーバーで利用可能な高速 NIC の利用率が向上します。
* NFS セッション トランキングにより、データ転送速度が向上し、可用性とフォールト トレランスが向上します。
* SMB マルチチャネルは、データ転送速度の向上、高可用性、フォールト トレランスを実現します。
* ファイル権限のための Active Directory/LDAP との統合。
* TLS 経由の NFS による安全な接続。
* NFS Kerberos サポート。
* RDMA 経由の NFS。
* Windows と Unix の ID 間の名前マッピング。
* 自律的なランサムウェア保護。
* ファイル システム分析。


*サン*

* SnapMirrorアクティブ同期を使用して、障害ドメイン全体にクラスターを拡張します。常に確認する https://mysupport.netapp.com/matrix/#welcome["Interoperability Matrix Tool"] サポートされている構成の場合。
* ASAモデルは、アクティブ/アクティブ マルチパスと高速パス フェールオーバーを提供します。
* FC、iSCSI、NVMe-oF プロトコルのサポート。
* iSCSI CHAP 相互認証のサポート。
* 選択的な LUN マップとポートセット。




== ONTAPでサポートされるProxmox VEストレージタイプ

NAS プロトコル (NFS/SMB) は Proxmox VE のすべてのコンテンツ タイプをサポートし、通常はデータセンター レベルで 1 回構成されます。ゲスト VM は、NAS ストレージ上の raw、qcow2、または VMDK タイプのディスクを使用できます。  ONTAPスナップショットを可視化して、クライアントからデータのポイントインタイムコピーにアクセスできるようになります。 SAN プロトコル (FC/iSCSI/NVMe-oF) を使用したブロック ストレージは通常、ホストごとに構成され、Proxmox VE でサポートされている VM ディスクおよびコンテナ イメージのコンテンツ タイプに制限されます。ゲスト VM とコンテナーは、ブロック ストレージを Raw デバイスとして消費します。

[cols="25% 15% 15% 15% 15% 15%"]
|===
| コンテンツタイプ | NFS | SMB / CIFS | FC | iSCSI | NVMe-oF 


| バックアップ | はい | はい  a| 
いいえ^1^
 a| 
いいえ^1^
 a| 
いいえ^1^



| VM ディスク数 | はい | はい  a| 
はい^2^
 a| 
はい^2^
 a| 
はい^2^



| CTボリューム | はい | はい  a| 
はい^2^
 a| 
はい^2^
 a| 
はい^2^



| ISOイメージ | はい | はい  a| 
いいえ^1^
 a| 
いいえ^1^
 a| 
いいえ^1^



| CTテンプレート | はい | はい  a| 
いいえ^1^
 a| 
いいえ^1^
 a| 
いいえ^1^



| スニペット | はい | はい  a| 
いいえ^1^
 a| 
いいえ^1^
 a| 
いいえ^1^

|===
*注:* 1 - 共有フォルダーを作成し、ディレクトリ ストレージ タイプを使用するには、クラスター ファイル システムが必要です。  2 - LVM ストレージ タイプを使用します。



== SMB/CIFSストレージ

SMB/CIFS ファイル共有を利用するには、ストレージ管理者が実行する必要がある特定のタスクがあり、仮想化管理者は Proxmox VE UI またはシェルを使用して共有をマウントできます。 SMB マルチチャネルはフォールト トレランスを提供し、パフォーマンスを向上させます。詳細については、link:https://www.netapp.com/pdf.html?item=/media/17136-tr4740.pdf["TR4740 - SMB 3.0 マルチチャネル"]


NOTE: パスワードはクリアテキスト ファイルに保存され、root ユーザーのみがアクセスできます。。 link:https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_cifs["Proxmox VE ドキュメント"] 。

.ONTAPを使用した SMB 共有ストレージ プール
video::5b4ae54a-08d2-4f7d-95ec-b22d015f6035[panopto,width=360]
.<strong>ストレージ管理タスク</strong>
[%collapsible%open]
====
ONTAPを初めて使用する場合は、System Manager インターフェイスを使用してこれらのタスクを完了すると、エクスペリエンスが向上します。

. SVM が SMB に対して有効になっていることを確認します。フォローするlink:https://docs.netapp.com/us-en/ontap/smb-config/configure-access-svm-task.html["ONTAP 9 ドキュメント"]詳細についてはこちらをご覧ください。
. コントローラごとに少なくとも 2 つの lif を用意します。上記のリンクの手順に従ってください。参考までに、このソリューションで使用される lifs のスクリーンショットを以下に示します。
+
image:proxmox-ontap-001.png["NASインターフェースの詳細"]

. Active Directory またはワークグループ ベースの認証を使用します。上記のリンクの手順に従ってください。
+
image:proxmox-ontap-002.png["ドメイン情報に参加"]

. ボリュームを作成します。  FlexGroupを使用するには、クラスター全体にデータを分散するオプションを必ずチェックしてください。
+
image:proxmox-ontap-023.png["FlexGroupオプション"]

. SMB 共有を作成し、権限を調整します。フォローするlink:https://docs.netapp.com/us-en/ontap/smb-config/configure-client-access-shared-storage-concept.html["ONTAP 9 ドキュメント"]詳細についてはこちらをご覧ください。
+
image:proxmox-ontap-003.png["SMB共有情報"]

. タスクを完了できるように、仮想化管理者に SMB サーバー、共有名、および資格情報を提供します。


====
.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. 共有認証に使用する SMB サーバー、共有名、および資格情報を収集します。
. 少なくとも 2 つのインターフェースが異なる VLAN に設定され (フォールト トレランスのため)、NIC が RSS をサポートしていることを確認します。
. 管理UIを使用する場合 `https:<proxmox-node>:8006`、データセンターをクリックし、ストレージを選択し、追加をクリックして、SMB/CIFS を選択します。
+
image:proxmox-ontap-004.png["SMBストレージナビゲーション"]

. 詳細を入力すると、共有名が自動的に入力されます。すべてのコンテンツが選択されていることを確認します。[Add]をクリックします。
+
image:proxmox-ontap-005.png["SMBストレージの追加"]

. マルチチャネル オプションを有効にするには、クラスターのいずれかのノードでシェルを開き、pvesm set pvesmb01 --options multichannel,max_channels=4 と入力します。
+
image:proxmox-ontap-006.png["マルチチャンネル設定"]

. 上記のタスクの /etc/pve/storage.cfg の内容は次のとおりです。
+
image:proxmox-ontap-007.png["SMBのストレージ構成ファイル"]



====


== NFS ストレージ

ONTAP は、Proxmox VE でサポートされているすべての NFS バージョンをサポートします。フォールトトレランスとパフォーマンス強化を実現するには、link:https://docs.netapp.com/us-en/ontap/nfs-trunking/index.html["セッショントランキング"]が活用されます。セッション トランキングを使用するには、最低でも NFS v4.1 が必要です。

ONTAPを初めて使用する場合は、System Manager インターフェイスを使用してこれらのタスクを完了すると、エクスペリエンスが向上します。

.ONTAPの NFS nconnect オプション
video::f6c9aba3-b070-45d6-8048-b22e001acfd4[panopto,width=360]
.<strong>ストレージ管理タスク</strong>
[%collapsible%open]
====
. SVM が NFS に対して有効になっていることを確認します。参照link:https://docs.netapp.com/us-en/ontap/nfs-config/verify-protocol-enabled-svm-task.html["ONTAP 9 ドキュメント"]
. コントローラごとに少なくとも 2 つの lif を用意します。上記のリンクの手順に従ってください。参考までに、私たちのラボで使用している lifs のスクリーンショットを以下に示します。
+
image:proxmox-ontap-001.png["NASインターフェースの詳細"]

. Proxmox VE ホストの IP アドレスまたはサブネットへのアクセスを提供する NFS エクスポート ポリシーを作成または更新します。参照link:https://docs.netapp.com/us-en/ontap/nfs-config/create-export-policy-task.html["輸出ポリシーの作成"]そしてlink:https://docs.netapp.com/us-en/ontap/nfs-config/add-rule-export-policy-task.html["エクスポートポリシーにルールを追加する"]。
. link:https://docs.netapp.com/us-en/ontap/nfs-config/create-volume-task.html["ボリュームの作成"] 。FlexGroupを使用するには、クラスター全体にデータを分散するオプションを必ずチェックしてください。
+
image:proxmox-ontap-023.png["FlexGroupオプション"]

. link:https://docs.netapp.com/us-en/ontap/nfs-config/associate-export-policy-flexvol-task.html["ボリュームにエクスポートポリシーを割り当てる"]
+
image:proxmox-ontap-008.png["NFSボリューム情報"]

. NFS ボリュームの準備ができたことを仮想化管理者に通知します。


====
.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. 少なくとも 2 つのインターフェースが異なる VLAN に設定されていることを確認します (フォールト トレランスのため)。  NIC ボンディングを使用します。
. 管理UIを使用する場合 `https:<proxmox-node>:8006`、データセンターをクリックし、ストレージを選択し、追加をクリックして、NFS を選択します。
+
image:proxmox-ontap-009.png["NFSストレージナビゲーション"]

. 詳細を入力します。サーバー情報を提供すると、NFS エクスポートが入力され、リストから選択できるようになります。コンテンツ オプションを選択することを忘れないでください。
+
image:proxmox-ontap-010.png["NFSストレージの追加"]

. nConnect オプションを有効にするには、クラスターのいずれかのノードでシェルに移動し、「pvesm set pvenfs01 --options nconnect=4」と入力します。ここで、pvenfs01 は上記の手順で作成したストレージ ID です。トランキング機能を使用する場合は、少なくともNFS v4.1が使用されていることを確認し、オプションtrunkdiscoveryを設定してください。pvesm set pvenfs01 --options vers=4.1,trunkdiscovery


====


== iSCSI を使用した LVM

.ONTAPを使用した iSCSI による LVM 共有プール
video::d66ef67f-bcc2-4ced-848e-b22e01588e8c[panopto,width=360]
Proxmox ホスト間で共有されるストレージ用に論理ボリューム マネージャを構成するには、次のタスクを実行します。

.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. 2 つの Linux VLAN インターフェイスが利用可能であることを確認します。
. すべての Proxmox VE ホストに multipath-tools がインストールされていることを確認します。起動時に開始されることを確認します。
+
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools
systemctl enable multipathd
----
. すべての Proxmox VE ホストの iscsi ホスト IQN を収集し、それをストレージ管理者に提供します。
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----


====
.<strong>ストレージ管理タスク</strong>
[%collapsible%open]
====
ONTAPを初めて使用する場合は、System Manager を使用するとより快適に使用できます。

. iSCSI プロトコルが有効になっている SVM が使用可能であることを確認します。フォローするlink:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["ONTAP 9 ドキュメント"]
. コントローラごとに iSCSI 専用の lif を 2 つ用意します。
+
image:proxmox-ontap-013.png["iSCSIインターフェースの詳細"]

. igroup を作成し、ホスト iSCSI イニシエーターに入力します。
. SVM 上に希望のサイズの LUN を作成し、上記の手順で作成した igroup に提示します。
+
image:proxmox-ontap-014.png["iSCSI LUNの詳細"]

. LUN が作成されたことを仮想化管理者に通知します。


====
.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. 管理UIに移動 `https:<proxmox node>:8006`、データセンターをクリックし、ストレージを選択し、追加をクリックして、iSCSI を選択します。
+
image:proxmox-ontap-015.png["iSCSIストレージナビゲーション"]

. ストレージ ID 名を指定します。通信の問題がない場合、 ONTAPからの iSCSI lif アドレスはターゲットを選択できるはずです。ゲスト VM に LUN アクセスを直接提供しないことが目的なので、そのチェックを外します。
+
image:proxmox-ontap-016.png["iSCSIストレージタイプの作成"]

. 次に、「追加」をクリックして LVM を選択します。
+
image:proxmox-ontap-017.png["LVM ストレージナビゲーション"]

. ストレージ ID 名を指定し、上記の手順で作成した iSCSI ストレージと一致するベース ストレージを選択します。ベースボリュームの LUN を選択します。ボリューム グループ名を指定します。共有が選択されていることを確認します。
+
image:proxmox-ontap-018.png["LVMストレージの作成"]

. 以下は、iSCSI ボリュームを使用する LVM のサンプル ストレージ構成ファイルです。
+
image:proxmox-ontap-019.png["LVM iSCSI 構成"]



====


== NVMe/TCP を使用した LVM

.ONTAPを使用した NVMe/TCP による LVM 共有プール
video::80164fe4-06db-4c21-a25d-b22e0179c3d2[panopto,width=360]
Proxmox ホスト間で共有されるストレージ用に論理ボリューム マネージャを構成するには、次のタスクを実行します。

.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. 2 つの Linux VLAN インターフェイスが利用可能であることを確認します。
. クラスター上のすべての Proxmox ホストで次のコマンドを実行して、ホスト イニシエーター情報を収集します。
+
[source, shell]
----
nvme show-hostnqn
----
. 収集したホスト nqn 情報をストレージ管理者に提供し、必要なサイズの nvme 名前空間を要求します。


====
.<strong>ストレージ管理タスク</strong>
[%collapsible%open]
====
ONTAPを初めて使用する場合は、System Manager を使用するとより使いやすくなります。

. NVMe プロトコルが有効になっている状態で SVM が使用可能であることを確認します。参照するlink:https://docs.netapp.com/us-en/ontap/san-admin/create-nvme-namespace-subsystem-task.html["ONTAP 9のNVMeタスクに関するドキュメント"]。
. NVMe 名前空間を作成します。
+
image:proxmox-ontap-020.png["nvme名前空間の作成"]

. サブシステムを作成し、ホスト nqns を割り当てます (CLI を使用している場合)。上記の参照リンクに従ってください。
. nvme 名前空間が作成されたことを仮想化管理者に通知します。


====
.<strong>仮想化管理タスク</strong>
[%collapsible%open]
====
. クラスター内の各 Proxmox VE ホストのシェルに移動し、/etc/nvme/discovery.conf ファイルを作成し、環境に固有のコンテンツを更新します。
+
[source, shell]
----
root@pxmox01:~# cat /etc/nvme/discovery.conf
# Used for extracting default parameters for discovery
#
# Example:
# --transport=<trtype> --traddr=<traddr> --trsvcid=<trsvcid> --host-traddr=<host-traddr> --host-iface=<host-iface>

-t tcp -l 1800 -a 172.21.118.153
-t tcp -l 1800 -a 172.21.118.154
-t tcp -l 1800 -a 172.21.119.153
-t tcp -l 1800 -a 172.21.119.154
----
. nvmeサブシステムにログインする
+
[source, shell]
----
nvme connect-all
----
. デバイスの詳細を検査して収集します。
+
[source, shell]
----
nvme list
nvme netapp ontapdevices
nvme list-subsys
lsblk -l
----
. ボリューム グループの作成
+
[source, shell]
----
vgcreate pvens02 /dev/mapper/<device id>
----
. 管理UIに移動 `https:<proxmox node>:8006`、データセンターをクリックし、ストレージを選択し、追加をクリックして、LVM を選択します。
+
image:proxmox-ontap-017.png["LVM ストレージナビゲーション"]

. ストレージ ID 名を指定し、既存のボリューム グループを選択して、CLI で作成したボリューム グループを選択します。共有オプションを必ずチェックしてください。
+
image:proxmox-ontap-021.png["既存の vg 上の lvm"]

. NVMe/TCP を使用した LVM のサンプルストレージ構成ファイルは次のとおりです。
+
image:proxmox-ontap-022.png["NVME 上の LVM TCP 構成"]



====