---
sidebar: sidebar 
permalink: vmware/vmw-vcf-disaster-recovery-nfs.html 
keywords: netapp, vmware, cloud, foundation, vcf, nfs 
summary: NetApp Disaster Recoveryを使用した VCF 向け災害復旧ソリューション。 
---
= NetApp Disaster Recoveryによる災害復旧の実装
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
NetApp SnapMirrorとNetApp Disaster Recoveryを使用した NFS データストア向け VCF 災害復旧ソリューション

運用サイトから災害復旧 (DR) サイトへのブロックレベルのレプリケーションは、サイトの停止やランサムウェア攻撃などのデータ破損イベントからワークロードを保護するための、回復力がありコスト効率に優れた戦略を提供します。  NetApp SnapMirrorレプリケーションにより、オンプレミスのONTAPシステムで実行されている VMware VCF 9 ワークロード ドメイン (NFS または VMFS データストアを使用) を、VMware も導入されている指定されたリカバリ データセンターにあるセカンダリONTAPシステムにレプリケートできるようになります。

詳細については、以下を参照してください。link:https://docs.netapp.com/us-en/data-services-disaster-recovery/["NetApp Disaster Recoveryドキュメント"] 。

このセクションでは、オンプレミスの VMware 仮想マシンの DR を確立するためのNetApp Disaster Recoveryの構成について説明します。

セットアップには以下が含まれます:

* NetApp Consoleアカウントを作成し、エージェントを展開します。
* VMware vCenter とONTAPストレージ間の通信を容易にするために、管理下のシステムのNetApp ConsoleにONTAPアレイを追加します。
* SnapMirrorを使用してサイト間のレプリケーションを構成します。
* フェイルオーバーの準備を検証するためのリカバリ プランを設定およびテストします。


NetApp Consoleに統合されたNetApp Disaster Recoveryにより、組織はオンプレミスの VMware vCenter およびONTAPストレージ システムをシームレスに検出できるようになります。検出されると、管理者はリソース グループを定義し、災害復旧計画を作成し、適切なリソースに関連付け、フェールオーバーおよびフェールバック操作を開始またはテストできます。NetApp SnapMirror は、効率的なブロックレベルのレプリケーションを提供し、増分更新を通じて DR サイトが実稼働環境と同期された状態を維持できるようにします。これにより、最短 5 分でリカバリポイント目標 (RPO) を実現できます。

NetApp Disaster Recovery は、中断を伴わない災害復旧テストもサポートします。ONTAP のFlexCloneテクノロジーを活用して、実稼働ワークロードに影響を与えたり追加のストレージ コストが発生したりすることなく、最新の複製されたスナップショットから NFS データストアのスペース効率の高い一時コピーを作成します。テスト後、環境は簡単に解体でき、複製されたデータの整合性が維持されます。

実際のフェイルオーバーが発生した場合、 NetApp Consoleはリカバリ プロセスを調整し、ユーザーの介入を最小限に抑えて、指定された DR サイトで保護された仮想マシンを自動的に起動します。プライマリ サイトが復元されると、サービスはSnapMirror関係を元に戻し、すべての変更を元のサイトに複製して、スムーズで制御されたフェイルバックを可能にします。

これらすべての機能は、従来の災害復旧ソリューションに比べて大幅に低いコストで提供されます。

image::vmw-vcf-dr-nfs-001.png[NetApp Disaster Recoveryアーキテクチャ図]



== 開始

NetApp Disaster Recoveryを開始するには、 NetApp Consoleを使用してサービスにアクセスします。

. NetApp Consoleにログインします。
. NetApp Consoleの左側のナビゲーションから、[保護] > [災害復旧] を選択します。
. NetApp Disaster Recoveryダッシュボードが表示されます。
+
image::vmw-vcf-dr-nfs-002.png[NetApp Disaster Recoveryダッシュボード]



災害復旧計画を構成する前に、次の点を確認してください。link:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-prerequisites.html["前提条件"]満たされている:

* コンソール エージェントはNetApp Consoleに設定されます。
* エージェント インスタンスは、ソースおよびターゲットのワークロード ドメインの vCenter およびストレージ システムに接続できます。
* ストレージ NFS または VMFS データストアを提供するNetApp Data ONTAPクラスター。
* VMware 用の NFS または VMFS データストアをホストするオンプレミスのNetAppストレージ システムがNetApp Consoleに追加されます。
* DNS 名を使用する場合は、DNS 解決を実施する必要があります。それ以外の場合は、vCenter の IP アドレスを使用します。
* SnapMirrorレプリケーションは、指定された NFS または VMFS ベースのデータストア ボリュームに対して構成されます。
* 環境にサポートされているバージョンの vCenter Server および ESXi サーバーがインストールされていることを確認します。


ソースサイトと宛先サイト間の接続が確立されたら、構成手順に進みます。これには数回のクリックと約 3 ～ 5 分かかります。

注: NetApp、エージェントがネットワークを介してソース リソースおよび宛先リソースと通信できるように、コンソール エージェントを宛先サイトまたは 3 番目のサイトに展開することを推奨しています。

このデモでは、ワークロード ドメインはONTAP NFS ストレージで構成されています。  VMFS ベースのデータストアの場合、ワークフローに関する手順は同じままです。

image::vmw-vcf-dr-nfs-003.png[NetApp Disaster Recovery詳細ダッシュボード]



== NetApp Disaster Recovery構成

災害復旧の準備の最初のステップは、ソース vCenter とストレージ リソースを検出し、 NetApp Disaster Recoveryに追加することです。

NetApp Consoleを開き、左側のナビゲーションから [保護] > [災害復旧] を選択します。[サイト] を選択し、[追加] を選択します。新しいソース サイトの名前とその場所を入力します。手順を繰り返して、宛先サイトと場所を追加します。

image::vmw-vcf-dr-nfs-004.png[NetApp Disaster Recovery詳細ダッシュボード]

次のプラットフォームを追加します。

* ソースワークロードドメインvCenter
* 宛先ワークロード ドメイン vCenter。


vCenter が追加されると、自動検出がトリガーされます。



== ソースサイトアレイと宛先サイトアレイ間のストレージレプリケーションの構成

SnapMirror は、 NetApp環境でのデータ レプリケーションを提供します。NetApp Snapshot® テクノロジーに基づいて構築されたSnapMirrorレプリケーションは、前回の更新以降に変更または追加されたブロックのみを複製するため、非常に効率的です。SnapMirror は、 NetApp OnCommand® System Manager またはONTAP CLI を使用して簡単に設定できます。NetApp Disaster Recovery、クラスタと SVM ピアリングが事前に構成されている場合、 SnapMirror関係も作成されます。

プライマリ ストレージが完全に失われていない場合、 SnapMirror はプライマリ サイトと DR サイトを再同期する効率的な手段を提供します。SnapMirror は2 つのサイトを再同期し、 SnapMirror関係を単純に反転するだけで、変更されたデータまたは新しいデータのみを DR サイトからプライマリ サイトに転送できます。つまり、 NetApp Disaster Recoveryのレプリケーション プランは、フェイルオーバー後にボリューム全体を再コピーすることなく、どちらの方向にも再同期できます。関係が逆方向に再同期されると、スナップショット コピーの最後の正常な同期以降に書き込まれた新しいデータのみが宛先に送り返されます。


NOTE: CLI または System Manager を介してボリュームにSnapMirror関係がすでに構成されている場合、 NetApp Disaster Recovery は関係を取得し、残りのワークフロー操作を続行します。



== NetApp Disaster Recoveryのレプリケーション関係を設定する方法

SnapMirrorレプリケーションを作成するための基本的なプロセスは、どのアプリケーションでも同じです。 最も簡単な方法は、 NetApp Disaster Recovery を活用することです。これにより、次の 2 つの条件が満たされていれば、レプリケーション ワークフローが自動化されます。プロセスは手動でも自動でも実行できます。最も簡単な方法は、NetApp Disaster Recoveryの活用です。次の2つの条件を満たす場合、レプリケーション ワークフローを自動化できます:

* ソース クラスターと宛先クラスターにはピア関係があります。
* ソース SVM と宛先 SVM にはピア関係があります。


NetApp Consoleには、環境内のソースONTAPシステムを宛先にドラッグ アンド ドロップするだけで、残りのプロセスをガイドするウィザードを起動してSnapMirrorレプリケーションを構成するための代替オプションも用意されています。



== NetApp Disaster Recovery は何を実現しますか?

ソース サイトとターゲット サイトが追加されると、 NetApp Disaster Recovery は自動的に詳細な検出を実行し、VM と関連メタデータを表示します。NetApp Disaster Recovery は、VM で使用されるネットワークとポート グループも自動的に検出し、それらを入力します。

image::vmw-vcf-dr-nfs-005.png[NetApp Consoleサイト]

サイトを追加したら、ソースと宛先の vCenter プラットフォームを選択してレプリケーション プランを構成し、プランに含めるリソース グループ、アプリケーションの復元方法と電源投入方法のグループ化、およびクラスタとネットワークのマッピングを選択します。リカバリ プランを定義するには、[*レプリケーション プラン*] タブに移動し、[*追加*] をクリックします。

このステップでは、VM をリソース グループにグループ化できます。NetApp Disaster Recoveryリソース グループを使用すると、依存する VM のセットを、リカバリ時に実行できるブート順序とブート遅延を含む論理グループにグループ化できます。リソース グループは、レプリケーション プランの作成中、または左側のナビゲーションの [リソース グループ] タブを使用して作成できます。

まず、レプリケーション プランに名前を付け、ソース vCenter と宛先 vCenter を選択します。

image::vmw-vcf-dr-nfs-006.png[NetApp Disaster Recoveryターゲット vCenter]

次のステップでは、リソース グループ、仮想マシン、またはデータストアを使用してレプリケーション プランを作成するかどうかを選択します。既存のリソース グループを選択し、リソース グループが作成されていない場合は、ウィザードがリカバリ目標に基づいて必要な仮想マシンをグループ化します (基本的には機能リソース グループを作成します)。これは、アプリケーション仮想マシンを復元する操作シーケンスを定義するのにも役立ちます。

image::vmw-vcf-dr-nfs-007.png[NetApp Disaster Recoveryで保護するVMを選択]


NOTE: リソース グループでは、ドラッグ アンド ドロップ機能を使用してブート順序を設定できます。これを使用すると、リカバリプロセス中に VM の電源がオンになる順序を簡単に変更できます。

レプリケーション プランを使用してリソース グループを作成したら、次の手順では、災害発生時に仮想マシンとアプリケーションを回復するためのマッピングを作成します。このステップでは、ソース環境のリソースを宛先にどのようにマップするかを指定します。これには、コンピューティング リソース、仮想ネットワーク、IP カスタマイズ、事前スクリプトと事後スクリプト、ブート遅延、アプリケーションの一貫性などが含まれます。詳細については、link:https://docs.netapp.com/us-en/data-services-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["レプリケーションプランを作成する"] 。前提条件で述べたように、 SnapMirrorレプリケーションは事前に構成することも、レプリケーション プランの作成時に指定された RPO と保持数を使用して DRaaS で構成することもできます。

注: デフォルトでは、テスト操作とフェイルオーバー操作の両方に同じマッピング パラメータが使用されます。テスト環境に異なるマッピングを設定するには、「フェイルオーバーとテスト マッピングに同じマッピングを使用する」チェックボックスをオフにした後、テスト マッピング オプションを選択します。リソース マッピングが完了したら、[次へ] をクリックします。

image::vmw-vcf-dr-nfs-008.png[NetApp災害リソース マッピング]

完了したら、作成されたマッピングを確認し、「プランの追加」をクリックします。

image::vmw-vcf-dr-nfs-009.png[NetApp Disaster Recoveryリソース マッピングのレビュー]


NOTE: 異なるボリュームおよび SVM からの VM をレプリケーション プランに含めることができます。VM の配置 (同じボリューム上、同じ SVM 内の別のボリューム上、異なる SVM 上の別のボリューム上など) に応じて、 NetApp Disaster Recovery は整合性グループ スナップショットを作成します。

image::vmw-vcf-dr-nfs-010.png[NetApp Disaster Recoveryレプリケーション プラン]

計画が作成されるとすぐに、一連の検証がトリガーされ、選択に応じてSnapMirrorレプリケーションとスケジュールが構成されます。

image::vmw-vcf-dr-nfs-011.png[NetApp Disaster Recoveryジョブの監視]

NetApp Disaster Recoveryは、次のワークフローで構成されます。

* テストフェイルオーバー（定期的な自動シミュレーションを含む）
* クリーンアップフェイルオーバーテスト
* フェイルオーバー:
+
** 計画的な移行（1回限りのフェイルオーバーのユースケースの拡張）
** ディザスタ リカバリ


* フェイルバック


image::vmw-vcf-dr-nfs-012.png[NetApp Disaster Recoveryレプリケーションプランのアクション]



== テストフェイルオーバー

NetApp Disaster Recoveryのテスト フェイルオーバーは、VMware 管理者が実稼働環境を中断することなくリカバリ プランを完全に検証できるようにする運用手順です。

image::vmw-vcf-dr-nfs-013.png[NetApp Disaster Recoveryレプリケーション プランのテスト フェイルオーバー]

NetApp Disaster Recovery には、テスト フェイルオーバー操作のオプション機能としてスナップショットを選択する機能が組み込まれています。この機能により、VMware 管理者は、環境内で最近行われた変更が宛先サイトに複製され、テスト中に存在していることを確認できます。このような変更には、VM ゲスト オペレーティング システムへのパッチが含まれます。

image::vmw-vcf-dr-nfs-014.png[NetApp Disaster Recoveryレプリケーション プランのテスト フェイルオーバーの確認]

VMware 管理者がテスト フェイルオーバー操作を実行すると、 NetApp Disaster Recovery次のタスクが自動化されます。

* SnapMirror関係をトリガーして、本番サイトで行われた最近の変更を宛先サイトのストレージに反映します。
* DR ストレージ アレイ上のFlexVolボリュームのNetApp FlexCloneボリュームを作成します。
* FlexCloneボリューム内のデータストアを DR サイトの ESXi ホストに接続します。
* マッピング中に指定されたテスト ネットワークに VM ネットワーク アダプターを接続します。
* DR サイトのネットワークの定義に従って、VM ゲスト オペレーティング システムのネットワーク設定を再構成します。
* レプリケーション プランに保存されているカスタム コマンドを実行します。
* レプリケーション プランで定義された順序で VM の電源をオンにします。


image::vmw-vcf-dr-nfs-015.png[NetApp Disaster Recoveryレプリケーション プランのテスト フェイルオーバー結果]



== クリーンアップフェイルオーバーテスト操作

クリーンアップ フェイルオーバー テスト操作は、レプリケーション プラン テストが完了し、VMware 管理者がクリーンアップ プロンプトに応答した後に実行されます。

image::vmw-vcf-dr-nfs-016.png[NetApp Disaster Recoveryレプリケーション プランのテスト フェイルオーバーのクリーンアップ]

このアクションにより、仮想マシン (VM) とレプリケーション プランのステータスが準備完了状態にリセットされます。VMware 管理者がリカバリ操作を実行すると、 NetApp Disaster Recovery は次のプロセスを完了します。

. テストに使用されたFlexCloneコピー内の回復された各 VM の電源をオフにします。
. テスト中に回復された VM を表示するために使用されたFlexCloneボリュームを削除します。




== 計画的な移行とフェイルオーバー

NetApp Disaster Recovery には、実際のフェイルオーバーを実行するための 2 つの方法 (計画移行とフェイルオーバー) があります。最初の方法である計画移行では、VM のシャットダウンとストレージ レプリケーションの同期をプロセスに組み込んで、VM を回復するか、効率的に移行先サイトに移動します。計画された移行にはソース サイトへのアクセスが必要です。2 番目の方法であるフェールオーバーは、計画済み/計画外のフェールオーバーであり、完了できた最後のストレージ レプリケーション間隔から宛先サイトで VM が回復されます。ソリューションに設計された RPO に応じて、DR シナリオではある程度のデータ損失が予想されます。

image::vmw-vcf-dr-nfs-017.png[NetApp Disaster Recoveryレプリケーション プランのフェイルオーバー アクション]

image::vmw-vcf-dr-nfs-018.png[NetApp Disaster Recoveryレプリケーション プランのフェイルオーバー アクションの確認]

VMware 管理者がフェイルオーバー操作を実行すると、 NetApp Disaster Recovery次のタスクが自動化されます。

* NetApp SnapMirror関係を解除してフェイルオーバーします。
* 複製されたデータストアを DR サイトの ESXi ホストに接続します。
* VM ネットワーク アダプターを適切な宛先サイト ネットワークに接続します。
* 宛先サイトのネットワークの定義に従って、VM ゲスト オペレーティング システムのネットワーク設定を再構成します。
* レプリケーション プランに保存されているカスタム コマンド (存在する場合) を実行します。
* レプリケーション プランで定義された順序で VM の電源をオンにします。


image::vmw-vcf-dr-nfs-019.png[vSphere Client - VMの電源がオン]



== フェイルバック

フェイルバックは、回復後にソース サイトと宛先サイトの元の構成を復元するオプションの手順です。

image::vmw-vcf-dr-nfs-020.png[NetApp Disaster Recoveryレプリケーション プランのフェイルバック アクション]

VMware 管理者は、サービスを元のソース サイトに復元する準備ができたら、フェイルバック手順を構成して実行できます。


NOTE: NetApp Disaster Recovery は、レプリケーションの方向を反転する前に、すべての変更を元のソース仮想マシンにレプリケート (再同期) します。

このプロセスは、ターゲットへのフェールオーバーが完了した関係から開始され、次の手順が含まれます。

* 仮想マシンの電源をオフにして登録を解除すると、宛先サイトのボリュームがマウント解除されます。
+
image::vmw-vcf-dr-nfs-021.png[vSphere Client - 最近のタスク]

* 元のソースのSnapMirror関係を解除して、読み取り/書き込み可能にします。
* レプリケーションを元に戻すには、 SnapMirror関係を再同期します。
* ソースにボリュームをマウントし、ソース仮想マシンをパワーオンして登録します。
+
image::vmw-vcf-dr-nfs-022.png[vSphere Client - VMの電源がオン]



NetApp Disaster Recoveryのアクセスと設定の詳細については、link:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-intro.html["NetApp Disaster Recoveryについて学ぶ"] 。



== 監視とダッシュボード

NetApp Disaster RecoveryまたはONTAP CLI から、適切なデータストア ボリュームのレプリケーションのヘルス ステータスを監視し、ジョブ監視を介してフェイルオーバーまたはテスト フェイルオーバーのステータスを追跡できます。

image::vmw-vcf-dr-nfs-023.png[NetApp Disaster Recoveryジョブの監視]


NOTE: ジョブが現在進行中またはキューに入っており、それを停止したい場合は、キャンセルするオプションがあります。

NetApp Disaster Recoveryダッシュボードを使用すると、ディザスタ リカバリ サイトとレプリケーション プランのステータスを確実に評価できます。これにより、管理者は正常なサイトやプラン、切断されたサイトやプラン、または機能低下したサイトやプランを迅速に特定できます。

image::vmw-vcf-dr-nfs-024.png[NetApp Disaster Recovery のダッシュボードが更新されました]

これにより、調整およびカスタマイズされた災害復旧計画を処理するための強力なソリューションが提供されます。フェイルオーバーは、計画されたフェイルオーバーとして実行することも、災害が発生して DR サイトをアクティブ化する決定が下されたときにボタンをクリックするだけでフェイルオーバーを実行することもできます。
