---
sidebar: sidebar 
permalink: migration/shift-toolkit-migrate-esxi2hyperv.html 
keywords: netapp, vmware, esxi, vm, migration, virtualization, hyper-v, microsoft 
summary: Shift Toolkit を使用して VM を準備し、ディスク形式を変換し、ターゲット環境を構成し、VM を VMware ESXi から Microsoft Hyper-V に移行します。 
---
= Shift Toolkit を使用して VMware ESXi から Microsoft Hyper-V に VM を移行する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Shift Toolkit を使用して VM を準備し、ディスク形式を変換し、ターゲット環境を構成し、VM を VMware ESXi から Microsoft Hyper-V に移行します。

Shift Toolkit は、ディスク形式の変換と移行先環境でのネットワーク再構成を通じて、仮想化プラットフォーム間での VM の移行を可能にします。



== 開始する前に

移行を開始する前に、次の前提条件が満たされていることを確認してください。

.Hyper-V の要件
* スタンドアロン ホストまたはフェールオーバー クラスターとして構成された Hyper-V ホスト
* 管理者権限を持つ Hyper-V ユーザー アカウント
* Hyper-Vホストは最新のDNSエントリでネットワークに到達可能
* 適切なトランキングが設定された仮想スイッチ
* ネットワーク選択のための仮想スイッチタイプ「外部」
* NFS 共有（変換する VM 用）と宛先共有（変換された VM 用）が同じボリューム上にある
* SMB制約委任は次のように構成されます `Enable-SmbDelegation`アクセス拒否エラーを回避するため
* SMB 3.0 有効（デフォルト）
* SMB共有の継続的な可用性プロパティが有効
* ストレージ仮想マシン (SVM) で SMB のエクスポート ポリシーが無効になっています
+

NOTE: SCVMM は、現在のリリースでは移行のサポートされているエンドポイントではありません。

* Hyper-V FCI とホスト検出は DNS 解決に依存します。Shift Toolkit VM からホスト名が解決可能であることを確認します。解決に失敗した場合は、ホストファイルを更新する(`C:\Windows\System32\drivers\etc\hosts`) をクリックして、検出操作を再試行してください。


.VMware の要件
* VM VMDK は NFSv3 ボリューム上に配置されます (特定の VM のすべての VMDK は同じボリュームの一部である必要があります)
* VMwareツールはゲストVM上で実行されています
* 移行対象のVMは準備のため実行状態にあります
* 移行を開始する前にVMの電源をオフにする必要があります
* VMware Tools の削除は、VM の電源がオンになると、対象のハイパーバイザーで実行されます。


.ゲストVMの要件
* Windows VM の場合: ローカル管理者の資格情報を使用します (ドメイン資格情報も使用できますが、変換前に VM にユーザー プロファイルが存在することを確認してください)
* Linux VMの場合: パスワードプロンプトなしでsudoコマンドを実行する権限を持つユーザーを使用します（ユーザーはsudoersリストに含まれているか、 `/etc/sudoers.d/`フォルダ）




== ステップ1: 宛先サイトを追加する (Hyper-V)

宛先 Hyper-V 環境を Shift Toolkit に追加します。

.手順
. *新しいサイトを追加*をクリックし、*宛先*を選択します。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-307.png[宛先サイトを追加]

====
. 宛先サイトの詳細を入力します。
+
** *サイト名*: サイトの名前を入力してください
** *ハイパーバイザー*: ターゲットとして Hyper-V を選択
** *サイトの場所*: デフォルトのオプションを選択します
** *コネクタ*: デフォルトの選択を選択します


. *続行*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-308.png[目的地サイトの詳細]

====
. 宛先 Hyper-V の詳細を入力します。
+
** *Hyper-V スタンドアロンまたはフェールオーバー クラスター マネージャー*: IP アドレスまたは FQDN
** *ユーザー名*: アクセスするユーザー名 (UPN 形式: username@domain.com または domain\administrator)
** *パスワード*: リソースのインベントリを実行するために Hyper-V ホストまたは FCI インスタンスにアクセスするためのパスワード


. *自己署名証明書を受け入れる*を選択し、*続行*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-309.png[Hyper-Vの詳細]

====
. *サイトの作成*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-310.png[サイトを作成]

====
+

NOTE: ディスク形式の変換はボリューム レベルで同じボリューム内で行われるため、ソースと宛先のストレージ システムは同じである必要があります。





== ステップ2: リソースグループを作成する

VM をリソース グループに編成して、ブート順序とブート遅延構成を保持します。

.開始する前に
* 前提条件で指定されているとおりにqtreeがプロビジョニングされていることを確認します。
* 変換前に、新しく作成されたONTAP SVM 上の指定されたデータストアに VM を移動し、本番 NFS データストアをステージング領域から分離します。


.手順
. *リソース グループ* に移動し、*新しいリソース グループの作成* をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-311.png[新しいリソースグループを作成する]

====
. ドロップダウンから*ソースサイト*を選択し、*作成*をクリックします。
. リソース グループの詳細を入力し、ワークフローを選択します。
+
** *クローンベースの移行*: ソースハイパーバイザーから宛先ハイパーバイザーへのエンドツーエンドの移行を実行します
** *クローンベースの変換*: ディスクフォーマットを選択したハイパーバイザータイプに変換します
+
.例を表示
[%collapsible]
====
image::shift-toolkit-312.png[リソース グループの詳細]

====


. *続行*をクリックします。
. 検索オプションを使用して VM を選択します (デフォルトのフィルターは「データストア」です)。
+

NOTE: データストア ドロップダウンには、NFSv3 データストアのみが表示されます。  NFSv4 データストアは表示されません。

+
.例を表示
[%collapsible]
====
image::shift-toolkit-313.png[VMの選択]

====
+
.例を表示
[%collapsible]
====
image::shift-toolkit-314.png[データストアフィルター]

====
. 移行の詳細を更新します:
+
** *宛先サイト*を選択
** *宛先Hyper-Vエントリ*を選択
** データストアからQtreeへのマッピングを構成する
+
.例を表示
[%collapsible]
====
image::shift-toolkit-315.png[移行の詳細]

====
+
.例を表示
[%collapsible]
====
image::shift-toolkit-316.png[Qtreeマッピング]

====
+

NOTE: ESXiからHyper-VへVMを変換する際は、変換後のVMが保存される宛先パスがqtreeに設定されていることを確認してください。複数のqtreeを作成して、変換後のVMディスクを保存することができます。



. 選択したすべての VM の起動順序と起動遅延を構成します。
+
** *1*: 最初に電源を入れるVM
** *3*: デフォルト
** *5*: 最後に電源を入れたVM
+
.例を表示
[%collapsible]
====
image::shift-toolkit-317.png[ブート順序の設定]

====


. *リソース グループの作成*をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-318.png[リソース グループを作成]

====


.結果
リソース グループが作成され、ブループリントの構成の準備が整いました。



== ステップ3: 移行ブループリントを作成する

プラットフォーム マッピング、ネットワーク構成、VM 設定などの移行計画を定義するブループリントを作成します。

.手順
. *ブループリント* に移動し、*新しいブループリントの作成* をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-319.png[新しいブループリントを作成する]

====
. ブループリントの名前を指定し、ホスト マッピングを構成します。
+
** *ソースサイト*と関連するvCenterを選択します
** *宛先サイト*と関連するHyper-Vターゲットを選択します
** クラスターとホストのマッピングを構成する
+
.例を表示
[%collapsible]
====
image::shift-toolkit-320.png[ホストマッピング]

====


. リソース グループの詳細を選択し、[続行] をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-321.png[リソース グループの詳細]

====
. 複数のグループが存在する場合は、リソース グループの実行順序を設定します。
. 適切な仮想スイッチへのネットワーク マッピングを構成します。
+

NOTE: 仮想スイッチはHyper-V内で既にプロビジョニングされている必要があります。Hyper-V側では、ネットワーク選択でサポートされている仮想スイッチの種類は「外部」のみです。テスト移行の場合は、本番ネットワークの競合を避けるために「ネットワークを構成しない」を選択し、変換後にネットワーク設定を手動で割り当てます。

+
.例を表示
[%collapsible]
====
image::shift-toolkit-322.png[ネットワークマッピング]

====
+
.例を表示
[%collapsible]
====
image::shift-toolkit-323.png[ネットワーク構成オプション]

====
. ストレージ マッピングを確認します (VM の選択に基づいて自動的に選択されます)。
+

NOTE: 仮想マシンを SMB 共有から作成してパワーオンできるように、qtree が事前にプロビジョニングされ、必要な権限が割り当てられていることを確認します。

. 必要に応じて、prepareVM オーバーライド オプションを構成します。このオプションは、Shift Toolkit による VM の準備をスキップし、代わりにカスタム スクリプトを使用してこれらのタスクを実行する必要がある場合に便利です。また、特定の環境要件を満たすために IP アドレスをカスタマイズすることもできます。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-324.png[PrepareVM オーバーライド]

====
. VM の詳細で、構成の詳細を選択し、各 OS タイプのサービス アカウント資格情報を入力します。
+
** *Windows*: ローカル管理者権限を持つユーザーを使用します (ドメイン資格情報も使用できますが、変換前に VM にユーザー プロファイルが存在することを確認してください)
** *Linux*: パスワードプロンプトなしでsudoコマンドを実行できるユーザーを使用します（ユーザーはsudoersリストに含まれているか、 `/etc/sudoers.d/`フォルダ）
+
.例を表示
[%collapsible]
====
image::shift-toolkit-325.png[VM認証情報]

====


. IP 設定を構成します。
+
** *設定しない*: デフォルトオプション
** *IP を保持*: ソースシステムと同じ IP を保持します
** *DHCP*: ターゲットVMにDHCPを割り当てる
+
準備 VM フェーズ中に VM の電源がオンになっていること、VMware Tools がインストールされていること、準備スクリプトが適切な権限で実行されていることを確認します。



. VM 設定を構成します。
+
** CPU/RAMパラメータのサイズ変更（オプション）
** 起動順序と起動遅延を変更する
** *電源オン*: 移行後にVMの電源をオンにする場合に選択します（デフォルト: オン）
** *VMware ツールを削除*: 変換後に VMware ツールを削除します (デフォルト: 選択)
** *VMファームウェア*: Gen1 > BIOSおよびGen2 > EFI（自動）
** *MAC アドレスを保持*: ライセンス要件のために MAC アドレスを保持します
** *サービス アカウントのオーバーライド*: 必要に応じて別のサービス アカウントを指定します
** *VLANオーバーライド*: ターゲットハイパーバイザーが異なるVLAN名を使用している場合は、正しいタグ付きVLAN名を選択します。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-326.png[VM構成]

====


. *続行*をクリックします。
. 日時を選択して移行をスケジュールします。
+

NOTE: VM の準備に時間をかけるため、移行は少なくとも 30 分前にスケジュールしてください。

+
.例を表示
[%collapsible]
====
image::shift-toolkit-327.png[移行のスケジュール]

====
. *ブループリントを作成*をクリックします。


.結果
Shift Toolkit は、移行の準備としてソース VM 上でスクリプトを実行する prepareVM ジョブを開始します。

.例を表示
[%collapsible]
====
image::shift-toolkit-328.png[PrepareVMジョブ]

====
準備プロセス:

* ドライバー（RHEL/CentOS、Alma Linux）を追加し、VMwareツールを削除し、IP/ルート/DNS情報をバックアップするためのスクリプトを挿入します。
* invoke-VMScript を使用してゲスト VM に接続し、準備タスクを実行します。
* Windows VMの場合: スクリプトを以下に保存します `C:\NetApp`
* Linux VMの場合: スクリプトを次の場所に保存します `/NetApp`そして `/opt`


.例を表示
[%collapsible]
====
image::shift-toolkit-329.png[Windows準備スクリプト]

====
.例を表示
[%collapsible]
====
image::shift-toolkit-330.png[Linux準備スクリプト]

====

NOTE: CentOS または Red Hat を実行している Linux ソース VM の場合、Shift Toolkit はディスク変換前に必要な Hyper-V ドライバーを自動的にインストールし、変換後の起動が正常に行われるようにします。詳細については、link:https://access.redhat.com/solutions/3465011["RHEL VM を Hyper-V に移行した後、システムが Dracut で停止する"] 。

prepareVM が正常に完了すると、ブループリントのステータスが「アクティブ」に更新されます。移行はスケジュールされた時間に実行されるか、[移行] オプションをクリックして手動で開始できます。

.例を表示
[%collapsible]
====
image::shift-toolkit-331.png[VMの準備が完了しました]

====
.例を表示
[%collapsible]
====
image::shift-toolkit-332.png[アクティブブループリント]

====


== ステップ4: 移行を実行する

移行ワークフローをトリガーして、VM を VMware ESXi から Microsoft Hyper-V に変換します。

.開始する前に
* すべてのVMは計画されたメンテナンススケジュールに従って正常に電源オフになります
* Shift VMがドメインの一部であることを確認する
* CIFS共有が適切な権限で設定されていることを確認する
* 移行または変換に使用されるqtreeには適切なセキュリティスタイルがあります
* 簡単なテストとして、クラスタ内の任意のHyper-VホストからHyper-Vマネージャーを使用してVMを作成し、VHDXをCIFS共有に配置します。


.手順
. ブループリントで、[移行] をクリックします。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-333.png[移行オプション]

====
. VM の電源がオフになっていない場合、Shift Toolkit は続行する前に正常なシャットダウンを要求します。
+
.例を表示
[%collapsible]
====
image::shift-toolkit-334.png[シャットダウンプロンプト]

====
. Shift Toolkit は次のアクションを実行します。
+
** ブループリント内のすべてのVMの既存のスナップショットを削除します
** ソースでVMスナップショットをトリガーします
** ディスク変換前にボリュームのスナップショットをトリガーします
** すべてのVMのVMDKをVHDx形式に変換します
+
変換は数秒で完了するため、これが最速の移行方法となり、VM のダウンタイムが短縮されます。

+
.例を表示
[%collapsible]
====
image::shift-toolkit-335.png[移行中]

====
+
.例を表示
[%collapsible]
====
image::shift-toolkit-336.png[変換の進捗状況]

====
** ターゲットのVMの電源をオンにする
** 各VMにネットワークを登録する
** VMwareツールを削除し、トリガースクリプトまたはcronジョブを使用してIPアドレスを割り当てます




.結果
ジョブが完了すると、ブループリントのステータスが「移行完了」に変わります。

.例を表示
[%collapsible]
====
image::shift-toolkit-337.png[移行完了]

====
.例を表示
[%collapsible]
====
image::shift-toolkit-338.png[Hyper-V マネージャーの VM]

====
.例を表示
[%collapsible]
====
image::shift-toolkit-339.png[Hyper-V の VM の詳細]

====

NOTE: 同じ ESXi ソースから同じ Hyper-V 宛先への変換は、同時に 10 回までしかトリガーされません。


NOTE: 失敗があった場合、link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/remotely-manage-hyper-v-hosts["任意の認証プロトコルを使用して委任を有効にする"] 。


NOTE: 移行後、Windows VM の電源がオンになると、Shift Toolkit は、ネットワーク構成やリモート管理設定に関係なく、PowerShell Direct を使用して Windows ベースのゲスト VM に接続します。


NOTE: 変換後、VMware VM では NewDiskPolicy パラメータがデフォルトで offlineALL に設定されているため、OS ディスクを除く Windows OS 上のすべての VM ディスクがオフラインになります。修正するには、次の PowerShell コマンドを実行します。 `Set-StorageSetting -NewDiskPolicy OnlineAll`


NOTE: Shift Toolkit は、Linux ベースのディストリビューションの起動時に実行される cron ジョブを使用します。  Linux ベースの VM を Hyper-V ホストに配置すると、SSH 接続は作成されません。



== ビデオデモ

次のビデオでは、このソリューションで概説されているプロセスを説明します。

.Shift Toolkit を使用して ESXi から Hyper-V に VM を移行する
video::f191dd7d-e4e4-4e5a-9654-b26400f3e9c4[panopto,width=360]