---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-data-protection.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, data, protection 
summary: このソリューションは、 NetAppストレージにHyper-Vを導入するために必要な手順を提供します。 
---
= NetAppストレージにMicrosoft Hyper-Vを導入する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ONTAPストレージ ベースのソリューションとサードパーティのバックアップ統合を使用して、Microsoft Hyper-V 仮想マシンを展開します。このプロセスには、迅速なバックアップとリストア操作のためのONTAP Snapshot コピーとFlexCloneテクノロジの使用、エンタープライズ バックアップ管理のための CommVault IntelliSnap の構成、サイト間のバックアップと災害復旧のためのSnapMirrorレプリケーションの実装が含まれます。

クラスター環境でのディスク ID の競合などの Hyper-V バックアップ固有の考慮事項に対処し、スタンドアロン ホストと Hyper-V クラスターのデータ保護を最適化する方法を学習します。



== NetAppストレージスナップショットを使用した復元

VM のバックアップと迅速なリカバリまたはクローン作成は、 ONTAPボリュームの大きな強みの 1 つです。スナップショット コピーを使用すると、パフォーマンスに影響を与えずに、VM または CSV ボリューム全体のFlexCloneコピーをすばやく作成できます。これにより、実稼働データ ボリュームを複製し、QA、ステージング、開発環境にマウントするときに、データ破損のリスクなしに実稼働データを操作できるようになります。  FlexCloneボリュームは、データのコピーに必要なスペースを 2 倍にすることなく、実稼働データのテスト コピーを作成するのに役立ちます。

Hyper-V ノードは各ディスクに一意の ID を割り当て、それぞれのパーティション (MBR または GPT) を持つボリュームのスナップショットを作成すると、同じ一意の ID が保持されることに留意してください。 MBR はディスク署名を使用し、GPT は GUID (グローバル一意識別子) を使用します。スタンドアロン Hyper-V ホストの場合、 FlexCloneボリュームは競合なく簡単にマウントできます。これは、スタンドアロンの Hyper-V サーバーが重複したディスク ID を自動的に検出し、ユーザーの介入なしに動的に変更できるためです。このアプローチは、シナリオの要求に応じて VHD をコピーすることで VM を回復するために使用できます。

スタンドアロンの Hyper-V ホストの場合は簡単ですが、Hyper-V クラスターの場合は手順が異なります。リカバリ プロセスでは、 FlexCloneボリュームをスタンドアロン Hyper-V ホストにマッピングするか、diskpart を使用してFlexCloneボリュームをスタンドアロン Hyper-V ホストにマッピングすることで署名を手動で変更します (ディスク ID の競合によりディスクをオンラインにできなくなるため重要です)。完了したら、 FlexCloneボリュームをクラスターにマッピングします。



== サードパーティのソリューションを使用したバックアップと復元

*注*: このセクションでは Commvault を使用しますが、他のサードパーティ ソリューションにも適用できます。

CommVault IntelliSnap は、 ONTAPスナップショットを活用して、Hyper-V のハードウェアベースのスナップショットを作成します。バックアップは、Hyper-V ハイパーバイザーまたは VM グループの設定に基づいて自動化することも、VM グループまたは特定の VM に対して手動で実行することもできます。  IntelliSnap を使用すると、実稼働仮想化ファームへの負荷を最小限に抑えながら、Hyper-V 環境を高速に保護できます。 IntelliSnap テクノロジーと仮想サーバー エージェント (VSA) の統合により、 NetApp ONTAPアレイは、多数の仮想マシンとデータ ストアのバックアップをわずか数分で完了できるようになります。きめ細かなアクセスにより、完全なゲスト .vhd ファイルとともに、ストレージのセカンダリ層から個々のファイルとフォルダーを回復できます。

仮想化環境を構成する前に、アレイとのスナップショット統合を必要とする適切なエージェントを展開します。  Microsoft Hyper-V 仮想化環境では、次のエージェントが必要です。

* メディアエージェント
* 仮想サーバーエージェント (VSA)
* VSS ハードウェア プロバイダー (Windows Server 2012 以降のオペレーティング システム)


*アレイ管理を使用してNetAppアレイを構成する*

次の手順は、 ONTAPアレイと Hyper-V を利用する環境で IntelliSnap 仮想マシン バックアップを構成する方法を示しています。

. CommCell Console のリボンで、[ストレージ] タブをクリックし、[アレイ管理] をクリックします。
. アレイ管理ダイアログ ボックスが表示されます。
. [Add]をクリックします。
+
配列プロパティ ダイアログ ボックスが表示されます。

+
image:hyperv-deploy-009.png["配列プロパティダイアログの画像"]

. [全般] タブで、次の情報を指定します。
. スナップベンダーリストから、 NetAppを選択します。
. [名前] ボックスに、プライマリ ファイル サーバーのホスト名、完全修飾ドメイン名 (FQDN)、または TCP/IP アドレスを入力します。
. [アレイ アクセス ノード] タブで、使用可能なメディア エージェントを選択します。
. [スナップ構成] タブで、ニーズに応じてスナップショット構成プロパティを構成します。
. [OK]をクリックします。
. <必須手順> 完了したら、検出オプションを使用してストレージ仮想マシン (SVM) を自動的に検出し、SVM を選択して、追加オプションを使用して、CommServe データベースにNetApp管理エントリとして SVM を追加することで、NetApp ストレージ アレイ上の SVM も構成します。
+
image:hyperv-deploy-010.png["SVM をアレイ管理エントリとして構成するイメージ"]

. [詳細設定] (下の図を参照) をクリックし、[IntelliSnap を有効にする] チェックボックスをオンにします。
+
image:hyperv-deploy-011.png["IntelliSnap を有効にするオプションを表示する画像"]



アレイの構成に関する詳細な手順については、link:https://documentation.commvault.com/11.20/configuring_netapp_array_using_array_management.html["NetAppアレイの構成"]そしてlink:https://documentation.commvault.com/11.20/configure_storage_virtual_machine_on_netapp_storage_array.html["NetAppアレイ上のストレージ仮想マシンの構成"]

*ハイパーバイザーとしてHyper-Vを追加する*

次のステップは、Hyper-V ハイパーバイザーを追加し、VM グループを追加することです。

*前提条件*

* ハイパーバイザーは、Hyper-V クラスター、クラスター内の Hyper-V サーバー、またはスタンドアロンの Hyper-V サーバーになります。
* ユーザーは、Hyper-V Server 2012 以降の Hyper-V 管理者グループに属している必要があります。  Hyper-V クラスターの場合、ユーザー アカウントには完全なクラスター権限 (読み取りおよびフル コントロール) が必要です。
* バックアップおよび復元操作用のアクセス ノード (VSA プロキシ) を作成するために、仮想サーバー エージェント (VSA) をインストールする 1 つ以上のノードを特定します。  Hyper-V サーバーを検出するには、CommServe システムに VSA がインストールされている必要があります。
* Hyper-V 2012 R2 の変更ブロック追跡を使用するには、Hyper-V クラスター内のすべてのノードを選択します。


次の手順は、Hyper-V をハイパーバイザーとして追加する方法を示しています。

. コアのセットアップが完了したら、[保護] タブで [仮想化] タイルをクリックします。
. [サーバー バックアップ プランの作成] ページで、プランの名前を入力し、ストレージ、保持、およびバックアップ スケジュールに関する情報を入力します。
. ハイパーバイザーの追加ページが表示されます > ベンダーの選択: Hyper-V を選択します (IP アドレスまたは FQDN とユーザー資格情報を入力)
. Hyper-V サーバーの場合は、[ノードの検出] をクリックします。  「ノード」フィールドにデータが入力されたら、仮想サーバー エージェントをインストールする 1 つ以上のノードを選択します。
+
image:hyperv-deploy-012.png["Hyper-V ノードの検出を表示する画像"]

. 「次へ」をクリックし、「保存」をクリックします。
+
image:hyperv-deploy-013.png["前のステップの結果を示す画像"]

. [VM グループの追加] ページで、保護する仮想マシン (この場合は Demogrp が作成された VM グループ) を選択し、以下に示すように IntelliSnap オプションを有効にします。
+
image:hyperv-deploy-014.png["保護するVMの選択を示す画像"]

+
*注意*: VM グループで IntelliSnap が有効になっている場合、Commvault はプライマリ (スナップ) コピーとバックアップ コピーのスケジュール ポリシーを自動的に作成します。

. [Save]をクリックします。


アレイの構成に関する詳細な手順については、link:https://documentation.commvault.com/2023e/software/guided_setup_for_hyper_v.html["HyperV のガイド付きセットアップ"] 。

*バックアップを実行しています:*

. ナビゲーション ペインから、[保護] > [仮想化] に移動します。仮想マシン ページが表示されます。
. VM または VM グループをバックアップします。このデモでは、VM グループが選択されています。 VM グループの行で、アクション ボタン action_button をクリックし、[バックアップ] を選択します。この場合、nimplan は Demogrp および Demogrp01 に関連付けられたプランです。
+
image:hyperv-deploy-015.png["バックアップするVMを選択するダイアログを示す画像"]

. バックアップが成功すると、スクリーンキャプチャに示すように復元ポイントが利用可能になります。スナップ コピーから、完全な VM の復元とゲスト ファイルおよびフォルダーの復元を実行できます。
+
image:hyperv-deploy-016.png["バックアップの復元ポイントを表示する画像"]

+
*注意*: 重要な仮想マシンや頻繁に使用される仮想マシンの場合は、CSV ごとに仮想マシンの数を少なくしてください。



*復元操作を実行しています:*

復元ポイントを使用して、完全な VM、ゲスト ファイルとフォルダー、または仮想ディスク ファイルを復元します。

. ナビゲーション ペインから [保護] > [仮想化] に移動すると、[仮想マシン] ページが表示されます。
. VM グループ タブをクリックします。
. VM グループ ページが表示されます。
. VM グループ領域で、仮想マシンを含む VM グループの [復元] をクリックします。
. 復元タイプの選択ページが表示されます。
+
image:hyperv-deploy-017.png["バックアップの復元タイプを示す画像"]

. 選択内容に応じてゲスト ファイルまたは完全な仮想マシンを選択し、復元をトリガーします。
+
image:hyperv-deploy-018.png["復元のオプションを表示する画像"]



サポートされているすべての復元オプションの詳細な手順については、link:https://documentation.commvault.com/2023e/software/restores_for_hyper_v.html["Hyper-V の復元"] 。



== 高度なNetApp ONTAPオプション

NetApp SnapMirror は、効率的なサイト間ストレージ レプリケーションを可能にし、今日のグローバル企業に適した、迅速で信頼性が高く管理しやすい災害復旧を実現します。  SnapMirror は、LAN および WAN 経由で高速にデータを複製し、ミッションクリティカルなアプリケーションに高いデータ可用性と高速リカバリを提供するほか、優れたストレージ重複排除機能とネットワーク圧縮機能も提供します。 NetApp SnapMirrorテクノロジーにより、災害復旧によってデータセンター全体を保護できます。ボリュームはオフサイトの場所に増分的にバックアップできます。 SnapMirror は、必要な RPO と同じ頻度で、増分ブロックベースのレプリケーションを実行します。ブロック レベルの更新により、帯域幅と時間の要件が削減され、DR サイトでのデータの一貫性が維持されます。

重要なステップは、データセット全体の 1 回限りのベースライン転送を作成することです。増分更新を実行する前にこれが必要です。この操作には、ソースでのスナップショット コピーの作成と、それによって参照されるすべてのデータ ブロックの宛先ファイル システムへの転送が含まれます。初期化が完了すると、スケジュールされた更新または手動でトリガーされた更新が実行される場合があります。更新のたびに、新しいブロックと変更されたブロックのみがソース ファイルシステムからデスティネーション ファイルシステムに転送されます。この操作には、ソース ボリュームでのスナップショット コピーの作成、それをベースライン コピーと比較し、変更されたブロックのみを宛先ボリュームに転送することが含まれます。新しいコピーは、次回の更新のベースライン コピーになります。レプリケーションは定期的に行われるため、 SnapMirror は変更されたブロックを統合し、ネットワーク帯域幅を節約できます。書き込みスループットと書き込みレイテンシへの影響は最小限です。

回復は次の手順を実行することによって実行されます。

. セカンダリ サイトのストレージ システムに接続します。
. SnapMirror関係を解除
. SnapMirrorボリューム内の LUN を、セカンダリ サイトの Hyper-V サーバーのイニシエーター グループ (igroup) にマップします。
. LUN が Hyper-V クラスターにマップされたら、これらのディスクをオンラインにします。
. フェールオーバー クラスター PowerShell コマンドレットを使用して、ディスクを使用可能なストレージに追加し、CSV に変換します。
. CSV 内の仮想マシンを Hyper-V マネージャーにインポートし、高可用性を実現してからクラスターに追加します。
. VM をオンにします。

