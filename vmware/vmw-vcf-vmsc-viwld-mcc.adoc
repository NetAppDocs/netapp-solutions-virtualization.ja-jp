---
sidebar: sidebar 
permalink: vmware/vmw-vcf-vmsc-viwld-mcc.html 
keywords: netapp, vmware, cloud, foundation, vcf, aff, all-flash, nfs, array, ontap tools, otv, sddc, sddc manager, ontap tools, metrocluster 
summary:  
---
= MetroClusterを使用して VI ワークロード ドメインのストレッチ クラスタを構成する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
このユースケースでは、 ONTAP MetroClusterを使用して、NFS をプリンシパル データストアとして拡張 VCF VI ワークロード ドメインを構成する手順について説明します。この手順には、vSphere ホストと vCenter Server のデプロイ、NFS データストアのプロビジョニング、vSphere クラスタの検証、VCF 変換中の NSX の構成、および既存の VCF 管理ドメインへの vSphere 環境のインポートが含まれます。

VCF 上のワークロードは、vSphere Metro Storage Cluster (vMSC) によって保護されます。  FC または IP 展開のいずれかを備えたONTAP MetroCluster は、通常、VMFS および NFS データストアのフォールト トレランスを提供するために使用されます。

image:vmw-vcf-vmsc-viwld-mcc-001.png["VCF VI ワークロード ドメイン（vMSC、幅 500）"]



== はじめに

このソリューションでは、 ONTAP MetroClusterを使用して、NFS をプリンシパル データストアとしてステッチされた VCF VI ワークロード ドメインを実装する方法を説明します。  VI ワークロード ドメインは、SDDC Manager を使用して展開するか、既存の vSphere 環境を VI ワークロード ドメインとしてインポートすることができます。



== シナリオの概要

このシナリオでは、次の大まかな手順について説明します。

* vSphere ホストと vCenter サーバーをデプロイします。
* NFS データストアを vSphere ホストにプロビジョニングします。
* VCF インポート ツールを使用して、vSphere クラスターを検証します。
* VCF 変換中に NSX を作成するための JSON ファイルを構成します。
* VCF インポート ツールを使用して、vSphere 8 環境を VCF VI ワークロード ドメインとして既存の VCF 管理ドメインにインポートします。




== 前提条件

このシナリオには、次のコンポーネントと構成が必要です。

* サポートされているONTAP MetroCluster構成
* NFS トラフィックを許可するように構成されたストレージ仮想マシン (SVM)。
* NFS トラフィックを伝送し、SVM に関連付けられた IP ネットワーク上に論理インターフェイス (LIF) が作成されています。
* ネットワーク スイッチに接続された 4 台の ESXi ホストを備えた vSphere 8 クラスター。
* VCF 変換に必要なソフトウェアをダウンロードします。


以下は、 MetroCluster構成を示す System Manager のサンプル スクリーンショットです。image:vmw-vcf-vmsc-mgmt-mcc-015.png["4ノードMetroClusterIP"]

両方の障害ドメインからの SVM ネットワーク インターフェイスは次のとおりです。image:vmw-vcf-vmsc-mgmt-mcc-013.png["障害ドメイン 1 からの SVM ネットワーク インターフェース"]

image:vmw-vcf-vmsc-mgmt-mcc-014.png["障害ドメイン2からのSVMネットワークインターフェース"]

[注意] SVM はMetroCluster内の障害ドメインの 1 つでアクティブになります。

image:vmw-vcf-vmsc-mgmt-mcc-016.png["障害ドメイン1のSVM"]

image:vmw-vcf-vmsc-mgmt-mcc-017.png["障害ドメイン2のSVM"]

参照する https://knowledge.broadcom.com/external/article/312183/vmware-vsphere-support-with-netapp-metro.html["MetroClusterを使用した vMSC"]。

vSphere を VCF 5.2 に変換またはインポートする際にサポートされるストレージおよびその他の考慮事項については、以下を参照してください。 https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/considerations-before-converting-or-importing-existing-vsphere-environments-into-vcf-admin.html["既存の vSphere 環境を VMware Cloud Foundation に変換またはインポートする前に考慮すべき事項"] 。

VCF管理ドメインに変換するvSphereクラスタを作成する前に、 https://knowledge.broadcom.com/external/article/373968/vlcm-config-manager-is-enabled-on-this-c.html["vSphere クラスタにおける NSX の考慮事項"]

必要なソフトウェアについては、 https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/download-software-for-converting-or-importing-existing-vsphere-environments-admin.html["既存の vSphere 環境を変換またはインポートするためのソフトウェアをダウンロードする"] 。

ONTAPストレージシステムの構成については、link:https://docs.netapp.com/us-en/ontap["ONTAP 9ドキュメント"]中心。

VCFの設定方法については、以下を参照してください。link:https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2.html["VMware Cloud Foundation ドキュメント"] 。



== 展開手順

NFSを主データストアとしてVCFストレッチ管理ドメインを展開するには、

次の手順を実行します。

* vSphere ホストと vCenter をデプロイします。
* vSphere クラスターを作成します。
* NFS データストアをプロビジョニングします。
* VCF インポート ツールを vCenter アプライアンスにコピーします。
* VCF インポート ツールを使用して、vCenter アプライアンスの事前チェックを実行します。
* インポート プロセス中にデプロイする NSX クラスタの JSON ファイルを作成します。
* 必要なソフトウェアを SDDC マネージャーにアップロードします。
* vSphere クラスタを VCF VI ワークロード ドメインに変換します。


変換プロセスの概要については、以下を参照してください。 https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/convert-or-import-a-vsphere-environment-into-vmware-cloud-foundation-admin.html["vSphere 環境を管理ドメインに変換するか、VMware Cloud Foundation で vSphere 環境を VI ワークロード ドメインとしてインポートする"] 。



=== vSphereホストとvCenterを展開する

Broadcom サポート ポータルからダウンロードした ISO を使用してホストに vSphere を展開するか、vSphere ホストの既存の展開オプションを使用します。

.NFS データストアをホスト VM にマウントする
[%collapsible%open]
====
この手順では、NFS ボリュームを作成し、それをデータストアとしてマウントして VM をホストします。

. System Manager を使用してボリュームを作成し、vSphere ホストの IP サブネットを含むエクスポート ポリシーに接続します。image:vmw-vcf-vmsc-viwld-mcc-003.png["System Manager による NFS ボリュームの作成"]
. vSphere ホストに SSH で接続し、NFS データストアをマウントします。


[listing]
----
esxcli storage nfs add -c 4 -H 10.192.164.225 -s /WLD01_DS01 -v DS01
esxcli storage nfs add -c 4 -H 10.192.164.230 -s /WLD01_DS02 -v DS02
esxcli storage nfs list
----
[注意] ハードウェアアクセラレーションがサポートされていないと表示される場合は、最新のNFS VAAIコンポーネント（ NetAppサポートポータルからダウンロード）がvSphereホストにインストールされていることを確認してください。image:vmw-vcf-vmsc-mgmt-mcc-005.png["NFS VAAIコンポーネントをインストールする"]ボリュームをホストする SVM で vStorage が有効になっています。image:vmw-vcf-vmsc-mgmt-mcc-004.png["VAAI の SVM で vStorage を有効にする"] 。追加のデータストアが必要な場合は上記の手順を繰り返し、ハードウェア アクセラレーションがサポートされていることを確認します。image:vmw-vcf-vmsc-viwld-mcc-002.png["データストアのリスト。各断層領域から1つ"]

====
NFS データストアに vCenter をデプロイします。  vCenter アプライアンスで SSH と Bash シェルが有効になっていることを確認します。image:vmw-vcf-vmsc-viwld-mcc-004.png["VCF変換前"]



=== vSphere クラスタを作成する

. vSphere Web クライアントにログインし、NFS VAAI が展開されているホストの 1 つを追加して、データセンターと vSphere クラスターを作成します。クラスター内のすべてのホストを単一のイメージ オプションで管理することを選択しました。 [ヒント] クラスター レベルで構成を管理を選択しないでください。詳細については、 https://knowledge.broadcom.com/external/article/373968/vlcm-config-manager-is-enabled-on-this-c.html["vSphere クラスタにおける NSX の考慮事項"] 。  ONTAP MetroClusterを使用したvMSCのベストプラクティスについては、 https://docs.netapp.com/us-en/ontap-apps-dbs/vmware/vmware_vmsc_design.html#netapp-storage-configuration["vMSC 設計および実装ガイドライン"]
. 他の vSphere ホストをクラスタに追加します。
. 分散スイッチを作成し、ポート グループを追加します。
. https://techdocs.broadcom.com/us/en/vmware-cis/vsan/vsan/8-0/vsan-network-design/migrating-from-standard-to-distributed-vswitch.html["標準の vSwitch から分散スイッチにネットワークを移行します。"]




=== vSphere 環境を VCF VI ワークロード ドメインに変換する

次のセクションでは、SDDC マネージャをデプロイし、vSphere 8 クラスタを VCF 5.2 管理ドメインに変換する手順について説明します。必要に応じて、詳細については VMware のドキュメントが参照されます。

VMware by Broadcom の VCF インポート ツールは、vCenter アプライアンスと SDDC マネージャの両方で使用されるユーティリティで、構成を検証し、vSphere および VCF 環境の変換およびインポート サービスを提供します。

 https://docs.vmware.com/en/VMware-Cloud-Foundation/5.2/vcf-admin/GUID-44CBCB85-C001-41B2-BBB4-E71928B8D955.html["VCFインポートツールのオプションとパラメータ"] 。

.VCFインポートツールのコピーと抽出
[%collapsible%open]
====
VCF インポート ツールは、vCenter アプライアンスで使用され、vSphere クラスタが VCF 変換またはインポート プロセスに対して正常な状態にあることを検証します。

次の手順を実行します。

. 次の手順に従ってください https://docs.vmware.com/en/VMware-Cloud-Foundation/5.2/vcf-admin/GUID-6ACE3794-BF52-4923-9FA2-2338E774B7CB.html["VCFインポートツールをターゲットのvCenterアプライアンスにコピーします"]VMware Docs を参照して、VCF インポート ツールを正しい場所にコピーします。
. 次のコマンドを使用してバンドルを抽出します。
+
....
tar -xvf vcf-brownfield-import-<buildnumber>.tar.gz
....


====
.vCenterアプライアンスを検証する
[%collapsible%open]
====
VI ワークロード ドメインとしてインポートする前に、VCF インポート ツールを使用して vCenter アプライアンスを検証します。

. 次の手順に従ってください https://docs.vmware.com/en/VMware-Cloud-Foundation/5.2/vcf-admin/GUID-AC6BF714-E0DB-4ADE-A884-DBDD7D6473BB.html["変換前にターゲット vCenter で事前チェックを実行する"]検証を実行します。


====
.NSX 展開用の JSON ファイルを作成する
[%collapsible%open]
====
vSphere 環境を VMware Cloud Foundation にインポートまたは変換しながら NSX Manager をデプロイするには、NSX デプロイ仕様を作成します。  NSX の展開には少なくとも 3 台のホストが必要です。


NOTE: 変換またはインポート操作で NSX Manager クラスタをデプロイする場合、NSX VLAN でバックアップされたセグメントが使用されます。  NSX-VLAN でバックアップされたセグメントの制限の詳細については、「既存の vSphere 環境を VMware Cloud Foundation に変換またはインポートする前の考慮事項」セクションを参照してください。  NSX-VLANネットワークの制限については、以下を参照してください。 https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/considerations-before-converting-or-importing-existing-vsphere-environments-into-vcf-admin.html["既存の vSphere 環境を VMware Cloud Foundation に変換またはインポートする前に考慮すべき事項"] 。

以下は、NSX デプロイメント用の JSON ファイルの例です。

....
{
  "deploy_without_license_keys": true,
  "form_factor": "small",
  "admin_password": "****************",
  "install_bundle_path": "/nfs/vmware/vcf/nfs-mount/bundle/bundle-133764.zip",
  "cluster_ip": "10.61.185.105",
  "cluster_fqdn": "mcc-wld01-nsx.sddc.netapp.com",
  "manager_specs": [{
    "fqdn": "mcc-wld01-nsxa.sddc.netapp.com",
    "name": "mcc-wld01-nsxa",
    "ip_address": "10.61.185.106",
    "gateway": "10.61.185.1",
    "subnet_mask": "255.255.255.0"
  },
  {
    "fqdn": "mcc-wld01-nsxb.sddc.netapp.com",
    "name": "mcc-wld01-nsxb",
    "ip_address": "10.61.185.107",
    "gateway": "10.61.185.1",
    "subnet_mask": "255.255.255.0"
  },
  {
    "fqdn": "mcc-wld01-nsxc.sddc.netapp.com",
    "name": "mcc-wld01-nsxc",
    "ip_address": "10.61.185.108",
    "gateway": "10.61.185.1",
    "subnet_mask": "255.255.255.0"
  }]
}
....
JSON ファイルを SDDC マネージャーの vcf ユーザーのホーム フォルダーにコピーします。

====
.SDDC マネージャーにソフトウェアをアップロードする
[%collapsible%open]
====
VCF インポート ツールを vcf ユーザーのホーム フォルダにコピーし、NSX デプロイメント バンドルを SDDC マネージャの /nfs/vmware/vcf/nfs-mount/bundle/ フォルダにコピーします。

見る https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/convert-or-import-a-vsphere-environment-into-vmware-cloud-foundation-admin/seed-software-on-sddc-manager-admin.html["必要なソフトウェアを SDDC Manager アプライアンスにアップロードする"]詳細な手順については、こちらをご覧ください。

====
.変換前のvCenterの詳細チェック
[%collapsible%open]
====
管理ドメインの変換操作または VI ワークロード ドメインのインポート操作を実行する前に、既存の vSphere 環境の構成が変換またはインポートに対してサポートされていることを確認するために詳細なチェックを実行する必要があります。 。ユーザー vcf として SDDC Manager アプライアンスに SSH 接続します。  。  VCF インポート ツールをコピーしたディレクトリに移動します。 。次のコマンドを実行して、vSphere環境が変換できることを確認します。

....
python3 vcf_brownfield.py check --vcenter '<vcenter-fqdn>' --sso-user '<sso-user>' --sso-password '********' --local-admin-password '****************' --accept-trust
....
image:vmw-vcf-vmsc-viwld-mcc-008.png["VCF チェック VC"]

====
.vSphere クラスタを VCF VI ワークロード ドメインに変換する
[%collapsible%open]
====
変換プロセスを実行するには、VCF インポート ツールが使用されます。

次のコマンドを実行して、vSphere クラスタを VCF 管理ドメインに変換し、NSX クラスタをデプロイします。

....
python3 vcf_brownfield.py import --vcenter '<vcenter-fqdn>' --sso-user '<sso-user>' --sso-password '******' --vcenter-root-password '********' --local-admin-password '****************' --backup-password '****************' --domain-name '<Mgmt-domain-name>' --accept-trust --nsx-deployment-spec-path /home/vcf/nsx.json
....
vSphere ホスト上で複数のデータストアが使用可能な場合でも、どのデータストアをプライマリ データストアとして考慮する必要があるかを指定する必要はありません。

詳しい手順については、 https://techdocs.broadcom.com/us/en/vmware-cis/vcf/vcf-5-2-and-earlier/5-2/map-for-administering-vcf-5-2/importing-existing-vsphere-environments-admin/convert-or-import-a-vsphere-environment-into-vmware-cloud-foundation-admin.html["VCF変換手順"] 。

NSX VM は vCenter にデプロイされます。image:vmw-vcf-vmsc-viwld-mcc-005.png["VCF変換後"]

SDDC マネージャーには、指定された名前と NFS をデータストアとして作成された VI ワークロード ドメインが表示されます。image:vmw-vcf-vmsc-viwld-mcc-006.png["NFS を使用した VCF ドメイン"]

クラスターを検査すると、NFS データストアの情報が提供されます。image:vmw-vcf-vmsc-viwld-mcc-007.png["VCF からの NFS データストアの詳細"]

====
.VCFにライセンスを追加する
[%collapsible%open]
====
変換が完了したら、環境にライセンスを追加する必要があります。

. SDDC Manager UI にログインします。
. ナビゲーション ペインで *管理 > ライセンス* に移動します。
. *+ ライセンス キー* をクリックします。
. ドロップダウンメニューから製品を選択します。
. ライセンスキーを入力してください。
. ライセンスの説明を入力します。
. *[追加]*をクリックします。
. ライセンスごとにこれらの手順を繰り返します。


====