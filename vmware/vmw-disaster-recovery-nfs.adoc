---
sidebar: sidebar 
permalink: vmware/vmw-disaster-recovery-nfs.html 
keywords: dr, draas, bluexp, disaster recovery, nfs datastore 
summary: このドキュメントのセクションでは、オンプレミスの VMware VM の災害復旧を別の指定サイトに設定するためのBlueXP DRaaS の構成について説明します。 
---
= BlueXP disaster recoveryを使用して NFS データストアの災害復旧を設定する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
このユースケースでは、NFS データストアを使用するオンプレミスの VMware VM に対してBlueXP disaster recoveryを使用してディザスタ リカバリを設定する手順について説明します。この手順には、 BlueXPアカウントとコネクタの設定、VMware vCenter とONTAPストレージ間の通信を可能にするためのONTAPアレイの追加、サイト間のレプリケーションの構成、リカバリ プランの作成とテストが含まれます。

運用サイトから災害復旧サイトへのブロックレベルのレプリケーションを通じて災害復旧を実装することは、サイトの停止やランサムウェア攻撃などのデータ破損イベントからワークロードを保護するための、回復力がありコスト効率に優れた方法です。NetApp SnapMirrorレプリケーションを使用すると、NFS データストアを備えたオンプレミスのONTAPシステムで実行されている VMware ワークロードを、VMware も導入されている指定されたリカバリ データセンターにある別のONTAPストレージ システムに複製できます。



== はじめに

このドキュメントのセクションでは、オンプレミスの VMware VM の災害復旧を別の指定サイトに設定するためのBlueXP DRaaS の構成について説明します。このセットアップの一部として、 BlueXPアカウント、 BlueXPコネクタ、VMware vCenter からONTAPストレージへの通信を可能にするために必要なONTAPアレイがBlueXPワークスペース内に追加されます。さらに、このドキュメントでは、サイト間のレプリケーションを構成する方法と、リカバリ プランを設定およびテストする方法についても詳しく説明します。最後のセクションでは、サイト全体のフェールオーバーを実行する手順と、プライマリ サイトが回復されオンラインで購入されたときにフェールバックする方法について説明します。

NetApp BlueXPコンソールに統合されたBlueXP disaster recoveryサービスを利用することで、企業はオンプレミスの VMware vCenter とONTAPストレージを簡単に検出できます。組織は、リソース グループを作成し、災害復旧計画を作成し、それをリソース グループに関連付け、フェールオーバーとフェールバックをテストまたは実行できます。SnapMirror は、ストレージ レベルのブロック レプリケーションを提供して、2 つのサイトを増分変更で最新の状態に保ち、最大 5 分のリカバリ ポイント目標 (RPO) を実現します。さらに、本番環境に影響を与えたり、追加のストレージ コストが発生したりすることなく、災害復旧手順をシミュレートできます。

BlueXP disaster recoveryは、 ONTAP のFlexCloneテクノロジーを活用して、ディザスタ リカバリ サイトで最後に複製されたスナップショットから NFS データストアのスペース効率の高いコピーを作成します。災害復旧テストを完了すると、実際の複製された本番リソースに影響を与えることなく、テスト環境を簡単に削除できます。実際のフェイルオーバーが発生した場合、 BlueXP disaster recoveryサービスは、数回クリックするだけで、指定された災害復旧サイトで保護された仮想マシンを自動的に起動するために必要なすべての手順を調整します。このサービスは、必要に応じて、プライマリ サイトとのSnapMirror関係を逆転させ、フェイルバック操作のためにセカンダリ サイトからプライマリ サイトへの変更を複製します。これらすべての機能は、他のよく知られた代替手段に比べて、ほんのわずかなコストで提供されます。

image:dr-draas-nfs-001.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



== 開始

BlueXP disaster recoveryを開始するには、 BlueXPコンソールを使用してサービスにアクセスします。

. BlueXPにログインします。
. BlueXP の左側のナビゲーションから、[保護] > [災害復旧] を選択します。
. BlueXP disaster recoveryダッシュボードが表示されます。
+
image:dr-draas-nfs-002.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



災害復旧計画を構成する前に、次の前提条件が満たされていることを確認してください。

* BlueXPコネクタはNetApp BlueXPに設定されます。
* BlueXPコネクタ インスタンスは、ソースおよびターゲットの vCenter およびストレージ システムに接続できます。
* ストレージ NFS データストアを提供するNetApp Data ONTAPクラスター。
* VMware 用の NFS データストアをホストするオンプレミスのNetAppストレージ システムがBlueXPに追加されます。
* DNS 名を使用する場合は、DNS 解決を実施する必要があります。それ以外の場合は、vCenter の IP アドレスを使用します。
* 指定された NFS ベースのデータストア ボリュームに対してSnapMirrorレプリケーションが構成されます。
* 環境にサポートされているバージョンの vCenter Server および ESXi サーバーがインストールされていることを確認します。


ソースサイトと宛先サイト間の接続が確立されたら、構成手順に進みます。これには数回のクリックと約 3 ～ 5 分かかります。


NOTE: NetApp、 BlueXPコネクタがネットワークを介してソース リソースおよび宛先リソースと通信できるように、宛先サイトまたは 3 番目のサイトにBlueXPコネクタを展開することを推奨しています。

image:dr-draas-nfs-003.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



== BlueXP disaster recovery構成

災害復旧の準備の最初のステップは、オンプレミスの vCenter とストレージ リソースを検出し、 BlueXP disaster recoveryに追加することです。

BlueXPコンソールを開き、左側のナビゲーションから *保護 > 災害復旧* を選択します。*vCenter サーバーの検出* を選択するか、トップ メニューを使用して *サイト > 追加 > vCenter の追加* を選択します。

image:dr-draas-nfs-004.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

次のプラットフォームを追加します。

* *ソース*。オンプレミスの vCenter。
+
image:dr-draas-nfs-005.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

* *行き先*。VMC SDDC vCenter。
+
image:dr-draas-nfs-006.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



vCenter が追加されると、自動検出がトリガーされます。



== ソースサイトアレイと宛先サイトアレイ間のストレージレプリケーションの構成

SnapMirror は、 NetApp環境でのデータ複製を提供します。NetApp Snapshot テクノロジーに基づいて構築されたSnapMirrorレプリケーションは、前回の更新以降に変更または追加されたブロックのみを複製するため、非常に効率的です。SnapMirror は、 NetApp OnCommand System ManagerまたはONTAP CLI を使用して簡単に設定できます。BlueXP DRaaS は、クラスターと SVM ピアリングが事前に構成されている場合、 SnapMirror関係も作成します。

プライマリ ストレージが完全に失われていない場合、 SnapMirror はプライマリ サイトと DR サイトを再同期する効率的な手段を提供します。SnapMirror は2 つのサイトを再同期し、 SnapMirror関係を単純に反転するだけで、変更されたデータまたは新しいデータのみを DR サイトからプライマリ サイトに転送できます。つまり、 BlueXP DRaaS のレプリケーション プランは、フェイルオーバー後にボリューム全体を再コピーすることなく、どちらの方向にも再同期できます。関係が逆方向に再同期される場合、スナップショット コピーの最後の正常な同期以降に書き込まれた新しいデータのみが宛先に送り返されます。


NOTE: CLI または System Manager を介してボリュームにSnapMirror関係がすでに構成されている場合、 BlueXP DRaaS はその関係を取得し、残りのワークフロー操作を続行します。



== VMware Disaster Recoveryの設定方法

SnapMirrorレプリケーションを作成するプロセスは、どのアプリケーションでも同じです。このプロセスは手動でも自動でも実行できます。最も簡単な方法は、 BlueXPを利用して、環境内のソースONTAPシステムを宛先にドラッグ アンド ドロップするだけでSnapMirrorレプリケーションを構成し、残りのプロセスをガイドするウィザードを起動することです。

image:dr-draas-nfs-007.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

BlueXP DRaaS では、次の 2 つの条件が満たされている場合、同じことを自動化することもできます。

* ソース クラスターと宛先クラスターにはピア関係があります。
* ソース SVM と宛先 SVM にはピア関係があります。
+
image:dr-draas-nfs-008.png["入出力ダイアログまたは書かれたコンテンツを示す図"]




NOTE: CLI 経由でボリュームにSnapMirror関係がすでに設定されている場合、 BlueXP DRaaS はその関係を取得し、残りのワークフロー操作を続行します。



== BlueXP disaster recoveryは何を実現できるのでしょうか?

ソース サイトと宛先サイトが追加されると、 BlueXP disaster recoveryは自動的に詳細な検出を実行し、VM と関連メタデータを表示します。BlueXP disaster recoveryでは、VM で使用されるネットワークとポート グループも自動的に検出し、それらを入力します。

image:dr-draas-nfs-009.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

サイトを追加した後、VM をリソース グループにグループ化できます。BlueXP disaster recoveryリソース グループを使用すると、依存する VM のセットを、復旧時に実行できるブート順序とブート遅延を含む論理グループにグループ化できます。リソース グループの作成を開始するには、[*リソース グループ*] に移動し、[*新しいリソース グループの作成*] をクリックします。

image:dr-draas-nfs-010.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-draas-nfs-011.png["入出力ダイアログまたは書かれたコンテンツを示す図"]


NOTE: レプリケーション プランの作成時にリソース グループを作成することもできます。

VM のブート順序は、リソース グループの作成中に、簡単なドラッグ アンド ドロップ メカニズムを使用して定義または変更できます。

image:dr-draas-nfs-012.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

リソース グループを作成したら、次のステップは、災害発生時に仮想マシンとアプリケーションを復旧するための実行ブループリントまたは計画を作成することです。前提条件で述べたように、 SnapMirrorレプリケーションは事前に構成することも、レプリケーション プランの作成時に指定された RPO と保持数を使用して DRaaS で構成することもできます。

image:dr-draas-nfs-013.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-draas-nfs-014.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

ドロップダウンからソースと宛先の vCenter プラットフォームを選択してレプリケーション プランを構成し、プランに含めるリソース グループ、アプリケーションの復元方法と電源オン方法のグループ化、およびクラスタとネットワークのマッピングを選択します。リカバリ プランを定義するには、[*レプリケーション プラン*] タブに移動し、[*プランの追加*] をクリックします。

まず、ソース vCenter を選択し、次に宛先 vCenter を選択します。

image:dr-draas-nfs-015.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

次のステップは、既存のリソース グループを選択することです。リソース グループが作成されていない場合、ウィザードは、回復目標に基づいて必要な仮想マシンをグループ化します (基本的には機能リソース グループを作成します)。これは、アプリケーション仮想マシンを復元する操作シーケンスを定義するのにも役立ちます。

image:dr-draas-nfs-016.png["入出力ダイアログまたは書かれたコンテンツを示す図"]


NOTE: リソース グループでは、ドラッグ アンド ドロップ機能を使用してブート順序を設定できます。これを使用すると、リカバリプロセス中に VM の電源がオンになる順序を簡単に変更できます。


NOTE: リソース グループ内の各仮想マシンは、順序に基づいて順番に起動されます。2 つのリソース グループが並行して開始されます。

以下のスクリーンショットは、リソース グループが事前に作成されていない場合に、組織の要件に基づいて仮想マシンまたは特定のデータストアをフィルターするオプションを示しています。

image:dr-draas-nfs-017.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

リソース グループを選択したら、フェールオーバー マッピングを作成します。このステップでは、ソース環境のリソースを宛先にどのようにマップするかを指定します。これには、コンピューティング リソース、仮想ネットワークが含まれます。IP カスタマイズ、事前スクリプトと事後スクリプト、ブート遅延、アプリケーションの一貫性など。詳細については、link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#select-applications-to-replicate-and-assign-resource-groups["レプリケーションプランを作成する"] 。

image:dr-draas-nfs-018.png["入出力ダイアログまたは書かれたコンテンツを示す図"]


NOTE: デフォルトでは、テスト操作とフェイルオーバー操作の両方に同じマッピング パラメータが使用されます。テスト環境に異なるマッピングを設定するには、以下に示すようにチェックボックスをオフにした後、テスト マッピング オプションを選択します。

image:dr-draas-nfs-019.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

リソース マッピングが完了したら、[次へ] をクリックします。

image:dr-draas-nfs-020.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

繰り返しタイプを選択します。簡単に言えば、「移行」（フェイルオーバーを使用した 1 回限りの移行）または定期的な連続レプリケーション オプションを選択します。このチュートリアルでは、「複製」オプションが選択されています。

image:dr-draas-nfs-021.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

完了したら、作成されたマッピングを確認し、「プランの追加」をクリックします。


NOTE: 異なるボリュームおよび SVM からの VM をレプリケーション プランに含めることができます。VM の配置 (同じボリューム上、同じ SVM 内の別のボリューム上、異なる SVM 上の別のボリューム上など) に応じて、 BlueXP disaster recoveryでは整合性グループ スナップショットが作成されます。

image:dr-draas-nfs-022.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

image:dr-draas-nfs-023.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

BlueXP DRaaS は次のワークフローで構成されています。

* テストフェイルオーバー（定期的な自動シミュレーションを含む）
* クリーンアップフェイルオーバーテスト
* フェイルオーバー
* フェイルバック




== テストフェイルオーバー

BlueXP DRaaS のテスト フェイルオーバーは、VMware 管理者が実稼働環境を中断することなくリカバリ プランを完全に検証できるようにする運用手順です。

image:dr-draas-nfs-024.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

BlueXP DRaaS には、テスト フェイルオーバー操作のオプション機能としてスナップショットを選択する機能が組み込まれています。この機能により、VMware 管理者は、環境で最近行われた変更が宛先サイトに複製され、テスト中に存在していることを確認できます。このような変更には、VMゲストオペレーティングシステムへのパッチが含まれます。

image:dr-draas-nfs-025.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

VMware 管理者がテスト フェイルオーバー操作を実行すると、 BlueXP DRaaS は次のタスクを自動化します。

* SnapMirror関係をトリガーして、本番サイトで行われた最近の変更を宛先サイトのストレージに反映します。
* DR ストレージ アレイ上のFlexVolボリュームのNetApp FlexCloneボリュームを作成します。
* FlexCloneボリューム内の NFS データストアを DR サイトの ESXi ホストに接続します。
* マッピング中に指定されたテスト ネットワークに VM ネットワーク アダプターを接続します。
* DR サイトのネットワークの定義に従って、VM ゲスト オペレーティング システムのネットワーク設定を再構成します。
* レプリケーション プランに保存されているカスタム コマンドを実行します。
* レプリケーション プランで定義された順序で VM の電源をオンにします。
+
image:dr-draas-nfs-026.png["入出力ダイアログまたは書かれたコンテンツを示す図"]





== クリーンアップフェイルオーバーテスト操作

クリーンアップ フェイルオーバー テスト操作は、レプリケーション プラン テストが完了し、VMware 管理者がクリーンアップ プロンプトに応答した後に実行されます。

image:dr-draas-nfs-027.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

このアクションにより、仮想マシン (VM) とレプリケーション プランのステータスが準備完了状態にリセットされます。

VMware 管理者がリカバリ操作を実行すると、 BlueXP DRaaS は次のプロセスを完了します。

. テストに使用されたFlexCloneコピー内の回復された各 VM の電源をオフにします。
. テスト中に回復された VM を表示するために使用されたFlexCloneボリュームを削除します。




== 計画的な移行とフェイルオーバー

BlueXP DRaaS には、実際のフェイルオーバーを実行するための 2 つの方法 (計画された移行とフェイルオーバー) があります。最初の方法である計画移行では、VM のシャットダウンとストレージ レプリケーションの同期をプロセスに組み込んで、VM を回復するか、効率的に移行先サイトに移動させます。計画された移行にはソース サイトへのアクセスが必要です。2 番目の方法であるフェールオーバーは、計画済み/計画外のフェールオーバーであり、完了できた最後のストレージ レプリケーション間隔から宛先サイトで VM が回復されます。ソリューションに設計された RPO に応じて、DR シナリオではある程度のデータ損失が予想されます。

image:dr-draas-nfs-028.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

VMware 管理者がフェイルオーバー操作を実行すると、 BlueXP DRaaS は次のタスクを自動化します。

* NetApp SnapMirror関係を解除してフェイルオーバーします。
* 複製された NFS データストアを DR サイトの ESXi ホストに接続します。
* VM ネットワーク アダプターを適切な宛先サイト ネットワークに接続します。
* 宛先サイトのネットワークの定義に従って、VM ゲスト オペレーティング システムのネットワーク設定を再構成します。
* レプリケーション プランに保存されているカスタム コマンド (存在する場合) を実行します。
* レプリケーション プランで定義された順序で VM の電源をオンにします。


image:dr-draas-nfs-029.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



== フェイルバック

フェイルバックは、回復後にソース サイトと宛先サイトの元の構成を復元するオプションの手順です。

image:dr-draas-nfs-030.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

VMware 管理者は、サービスを元のソース サイトに復元する準備ができたら、フェイルバック手順を構成して実行できます。

*注意:* BlueXP DRaaS は、レプリケーションの方向を反転する前に、すべての変更を元のソース仮想マシンにレプリケート (再同期) します。このプロセスは、ターゲットへのフェールオーバーが完了した関係から開始され、次の手順が含まれます。

* 仮想マシンの電源をオフにして登録を解除すると、宛先サイトのボリュームがマウント解除されます。
* 元のソースのSnapMirror関係を解除して、読み取り/書き込み可能にします。
* レプリケーションを元に戻すには、 SnapMirror関係を再同期します。
* ソースにボリュームをマウントし、ソース仮想マシンをパワーオンして登録します。


BlueXP DRaaSへのアクセスと設定の詳細については、link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/get-started/dr-intro.html["BlueXP Disaster Recovery for VMware について学ぶ"] 。



== 監視とダッシュボード

BlueXPまたはONTAP CLI から、適切なデータストア ボリュームのレプリケーションのヘルス ステータスを監視し、ジョブ監視を介してフェイルオーバーまたはテスト フェイルオーバーのステータスを追跡できます。

image:dr-draas-nfs-031.png["入出力ダイアログまたは書かれたコンテンツを示す図"]


NOTE: ジョブが現在進行中またはキューに入っており、それを停止したい場合は、キャンセルするオプションがあります。

BlueXP disaster recoveryダッシュボードを使用すると、災害復旧サイトとレプリケーション プランの状態を確実に評価できます。これにより、管理者は正常なサイトやプラン、切断されたサイトやプラン、または機能低下したサイトやプランを迅速に特定できます。

image:dr-draas-nfs-032.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

これにより、調整およびカスタマイズされた災害復旧計画を処理するための強力なソリューションが提供されます。フェイルオーバーは、計画されたフェイルオーバーとして実行することも、災害が発生して DR サイトをアクティブ化する決定が下されたときにボタンをクリックするだけでフェイルオーバーを実行することもできます。

このプロセスについて詳しく知りたい場合は、詳細なウォークスルービデオをご覧いただくか、link:https://netapp.github.io/bluexp-draas-simulator/?frame-1["ソリューションシミュレータ"] 。
