---
sidebar: sidebar 
permalink: hyperv/hyperv-smas.html 
keywords: hyperv, hyper-v, snapmirror, active, sync, stretch, cluster, netapp, virtualization 
summary: このホワイト ペーパーでは、Microsoft ストレッチ クラスタ間の同期双方向レプリケーションを実現するSnapMirrorアクティブ同期テクノロジについて説明します。これにより、MSSQL や Oracle などのマルチサイト アプリケーション データが両方のサイトでアクティブにアクセス可能になり、同期されます。 
---
= NetApp SnapMirror Active SyncとMicrosoftストレッチクラスタを使用して同期レプリケーションを設定する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
SnapMirror Active Sync を使用して、Microsoft ストレッチ フェイルオーバー クラスター間の同期の双方向レプリケーションを構成します。この手順には、ストレッチ フェイルオーバー クラスターのインストール、クラスター間ピアリングの作成、 ONTAPを使用したメディエーターの構成、対称アクティブ/アクティブ保護の有効化、およびクラスター フェイルオーバー検証テストの実行が含まれます。



== はじめに

ONTAP 9.15.1 以降、 SnapMirrorアクティブ同期は対称アクティブ/アクティブ展開をサポートし、双方向同期レプリケーションを使用して保護された LUN の両方のコピーからの読み取りおよび書き込み I/O 操作を可能にします。  Windows ストレッチ クラスターは、複数の地理的な場所にまたがって高可用性と災害復旧を提供する Windows フェールオーバー クラスター機能の拡張機能です。 SnapMirrorアクティブ同期対称アクティブ/アクティブと、Windows フェイルオーバー クラスタリングなどのクラスター化されたアプリケーションを使用すると、Microsoft Hyper-V のビジネス クリティカルなアプリケーションの継続的な可用性を実現し、予期しないインシデント発生時に RTO と RPO をゼロにすることができます。このソリューションには次の利点があります。

* データ損失ゼロ: データが同期的に複製され、リカバリポイント目標 (RPO) がゼロになることを保証します。
* 高可用性と負荷分散: 両方のサイトがリクエストをアクティブに処理し、負荷分散と高可用性を実現します。
* ビジネス継続性: 対称型のアクティブ/アクティブ構成を実装して、両方のデータセンターがアプリケーションをアクティブに提供し、障害発生時にシームレスに引き継ぐことができるようにします。
* パフォーマンスの向上: 対称アクティブ/アクティブ構成を使用して、複数のストレージ システムに負荷を分散し、応答時間と全体的なシステム パフォーマンスを向上させます。


このホワイト ペーパーでは、Microsoft ストレッチ フェイルオーバー クラスター間のSnapMirrorアクティブ同期テクノロジによる同期双方向レプリケーションについて説明します。これにより、MSSQL や Oracle などのマルチサイト アプリケーション データが両方のサイトでアクティブにアクセス可能になり、同期されます。障害が発生した場合、アプリケーションはデータの損失やアクセスの損失なく、残りのアクティブ サイトに直ちにリダイレクトされ、高可用性、災害復旧、地理的な冗長性が実現されます。



== ユースケース

サイバー攻撃、停電、自然災害などの障害が発生した場合、グローバルに接続されたビジネス環境では、データ損失ゼロでビジネスクリティカルなアプリケーション データを迅速に回復することが求められます。こうした要求は、金融業界や、一般データ保護規則 (GDPR) などの規制要件を遵守する業界では高まっています。対称型のアクティブ/アクティブ構成を導入して、地理的に分散した場所間でデータを複製し、データへのローカル アクセスを提供し、地域的な停止が発生した場合でも継続性を確保します。

SnapMirrorアクティブ同期のユース ケースは次のとおりです。

.アプリケーションの導入による目標復旧時間（RTO）ゼロの実現
SnapMirrorアクティブ同期の展開では、プライマリ クラスターとミラー クラスターが存在します。プライマリ クラスター内の LUN (L1P) にはセカンダリ上にミラー (L1S) があり、読み取りと書き込みはホット プロキシミティ設定に基づいてホストのローカル サイトによって提供されます。

.アプリケーションの導入によるRTOゼロまたはTAFの実現
透過的アプリケーション フェイルオーバー (TAF) は、ホスト MPIO ソフトウェア ベースのパス フェイルオーバーに基づいており、ストレージへの中断のないアクセスを実現します。両方の LUN コピー (たとえば、プライマリ (L1P) とミラー コピー (L1S)) は同じ ID (シリアル番号) を持ち、ホストに対して読み取り/書き込み可能として報告されます。

.クラスタ アプリケーション
VMware vSphere Metro Storage Cluster (vMSC)、Oracle RAC、SQL を使用した Windows フェールオーバー クラスタリングなどのクラスター化されたアプリケーションでは、パフォーマンスのオーバーヘッドなしで VM が他のサイトにフェールオーバーできるように、同時アクセスが必要です。SnapMirrorアクティブ同期の対称アクティブ / アクティブは、双方向レプリケーションによってローカルでIOを処理することで、クラスタ アプリケーションの要件を満たします。

.災害シナリオ
地理的に分散したサイト間で、アプリケーション用の複数のボリュームを同期的にレプリケートします。プライマリで中断が発生した場合には、セカンダリ コピーに自動的にフェールオーバーできるため、Tier 1 アプリケーションのビジネス継続性が確保されます。

.Windowsフェイルオーバー
SnapMirrorアクティブ シンクは、使いやすいアプリケーション レベルの粒度と自動フェイルオーバーによる柔軟性を提供し、仮想環境と物理環境の両方で、Oracle、Microsoft SQL Server などのビジネス クリティカルなアプリケーションの高いデータ可用性と高速なデータ レプリケーションを実現します。



== ソリューション アーキテクチャ

Microsoft ストレッチ クラスターには、各サイトに 2 つの Hyper-V ノードがあります。これら 2 つのノードはNetAppストレージを共有し、 SnapMirrorアクティブ同期対称アクティブ/アクティブを使用して 2 つのサイト間でボリュームを複製します。整合性グループにより、データセットのすべてのボリュームが休止され、同じ時点でのSnapshotが作成されます。そのため、そのデータセットをサポートするボリューム間でデータ整合性のあるリストア ポイントが得られます。  ONTAPメディエーターは、ピアリングされたONTAPクラスタとノードに関するヘルス情報を受信し、両者の間でオーケストレーションを行い、各ノード/クラスタが正常で実行中かどうかを判断します。

ソリューションコンポーネント:

* 2つのNetAppストレージシステムONTAP 9.15.1: 第1および第2の障害ドメイン
* ONTAPメディエーター用のRedhat 8.7 VM
* Windows 2022 上の 3 つの Hyper-V フェールオーバー クラスター:
+
** アプリケーション用のサイト1、サイト2
** 仲介者のためのサイト3


* Hyper-V 上の VM: Microsoft ドメイン コントローラ、MSSQL Always On フェールオーバー クラスタ インスタンス、 ONTAP Mediator


image:hyperv-smas-001.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



=== Microsoft ストレッチ フェールオーバー クラスターをインストールする

Windows Admin Center、PowerShell、または Server Manager コンソールを使用して、フェールオーバー クラスタリング機能とそれに関連する PowerShell コマンドレットをインストールできます。前提条件と手順の詳細については、「フェールオーバー クラスターの作成」を参照してください。

Windows ストレッチ クラスターをセットアップするための手順ガイドは次のとおりです。

. 4台のサーバーすべて（hyperv1、hyperv2、hyperv3、hyperv4）にWindows 2022をインストールする
. 4 台のサーバーすべてを同じ Active Directory ドメイン (hyperv.local) に参加させます。
. 各サーバーに、Windows のフェールオーバー クラスタリング、Hyper-V、Hyper-V_Powershell、および MPIO 機能をインストールします。
+
[source, shell]
----
Install-WindowsFeature –Name "Failover-Clustering", "Hyper-V", "Hyper-V-Powershell", "MPIO" –IncludeManagementTools
----
. MPIO を構成し、iSCSI デバイスのサポートを追加します。
+
image:hyperv-smas-002.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. サイト 1 とサイト 2 のONTAPストレージで、2 つの iSCSI LUN (SQLdata と SQLlog) を作成し、Windows サーバー IQN グループにマップします。 Microsoft iSCSI ソフトウェア イニシエーターを使用して LUN を接続します。詳細については、link:https://docs.netapp.com/us-en/ontap-sm-classic/iscsi-config-windows/index.html["Windows向けのiSCSIの設定"] 。
. エラーや警告がないか、クラスター検証レポートを実行します。
+
[source, shell]
----
Test-Cluster –Node hyperv1, hyperv2, hyperv3, hyperv4
----
. フェイルオーバークラスターを作成し、静的IPアドレスを割り当て、
+
[source, shell]
----
New-Cluster –Name <clustername> –Node hyperv1, hyperv2, hyperv3, hyperv4, StaticAddress <IPaddress>
----
+
image:hyperv-smas-003.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. マップされた iSCSI ストレージをフェールオーバー クラスターに追加します。
. クォーラムの監視を構成するには、クラスターを右クリック -> [その他のアクション] -> [クラスター クォーラム設定の構成] をクリックし、ディスク監視を選択します。
+
下の図は、クラスター化された共有 LUN が 4 つ (sqldata と sqllog の 2 つのサイトと、クォーラム内のディスク監視が 1 つ) 示されています。

+
image:hyperv-smas-004.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



.Always On フェールオーバー クラスター インスタンス
Always On フェールオーバー クラスター インスタンス (FCI) は、WSFC 内の SAN 共有ディスク ストレージを持つノード全体にインストールされる SQL Server インスタンスです。フェールオーバー中、WSFC サービスはインスタンスのリソースの所有権を指定されたフェールオーバー ノードに転送します。その後、フェールオーバー ノードで SQL Server インスタンスが再起動され、データベースは通常どおりに回復されます。セットアップの詳細については、「SQL を使用した Windows フェールオーバー クラスタリング」を参照してください。各サイトに 2 つの Hyper-V SQL FCI VM を作成し、優先順位を設定します。サイト 1 の VM の優先所有者として hyperv1 と hyperv2 を使用し、サイト 2 の VM の優先所有者として hyperv3 と hyperv4 を使用します。

image:hyperv-smas-005.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



=== クラスタ間ピアリングの作成

SnapMirrorを使用して Snapshot コピーを複製する前に、ソース クラスタと宛先クラスタの間にピア関係を作成する必要があります。

. 両方のクラスタにクラスタ間ネットワーク インターフェイスを追加
+
image:hyperv-smas-006.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. cluster peer createコマンドを使用すると、ローカル クラスタとリモート クラスタ間にピア関係を作成できます。ピア関係が作成されたあとで、cluster peer createをリモート クラスタで実行して、ローカル クラスタに対してピア関係を認証できます。
+
image:hyperv-smas-007.png["入出力ダイアログまたは書かれたコンテンツを示す図"]





=== ONTAPでメディエーターを構成する

ONTAPメディエーターは、ピアリングされたONTAPクラスタとノードに関するヘルス情報を受信し、両者の間でオーケストレーションを行い、各ノード/クラスタが正常で実行中かどうかを判断します。 SM-as を使用すると、データがソース ボリュームに書き込まれるとすぐにターゲットに複製されます。メディエーターは、3 番目の障害ドメインに展開する必要があります。前提条件

* ハードウェア仕様: 8GB RAM、2x2GHz CPU、1Gb ネットワーク (<125ms RTT)
* Red Hat 8.7 OSをインストールし、チェックlink:https://docs.netapp.com/us-en/ontap/mediator/index.html["ONTAP MediatorのバージョンとサポートされているLinuxのバージョン"]。
* Mediator Linuxホストを構成する: ネットワーク設定とファイアウォールポート31784および3260
* yum-utilsパッケージをインストールする
* link:https://docs.netapp.com/us-en/ontap/mediator/index.html#register-a-security-key-when-uefi-secure-boot-is-enabled["UEFIセキュア ブートが有効になっている場合のセキュリティ キーの登録"]


.手順
. Mediatorインストールパッケージを以下からダウンロードします。link:https://mysupport.netapp.com/site/products/all/details/ontap-mediator/downloads-tab["ONTAPメディエーターのダウンロードページ"] 。
. ONTAP Mediator のコード署名を確認します。
. インストーラを実行し、必要に応じてプロンプトに応答します。
+
[source, shell]
----
./ontap-mediator-1.8.0/ontap-mediator-1.8.0 -y
----
. セキュア ブートが有効な場合、インストール後に追加の手順を実行してセキュリティ キーを登録する必要があります。
+
.. README ファイルの指示に従って、SCST カーネル モジュールに署名します。
+
[source, shell]
----
/opt/netapp/lib/ontap_mediator/ontap_mediator/SCST_mod_keys/README.module-signing
----
.. 必要なキーを特定します。
+
[source, shell]
----
/opt/netapp/lib/ontap_mediator/ontap_mediator/SCST_mod_keys
----


. インストールの確認
+
.. プロセスを確認します。
+
[source, shell]
----
systemctl status ontap_mediator mediator-scst
----
+
image:hyperv-smas-008.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

.. ONTAP Mediatorサービスで使用されているポートを確認します。
+
image:hyperv-smas-009.png["入出力ダイアログまたは書かれたコンテンツを示す図"]



. 自己署名証明書を使用したSnapMirrorアクティブ同期用のONTAP Mediatorの初期化
+
.. ONTAP Mediator Linux VM/ホスト ソフトウェアのインストール場所 cd /opt/netapp/lib/ontap_mediator/ontap_mediator/server_config からONTAP Mediator CA 証明書を見つけます。
.. ONTAP MediatorのCA証明書をONTAPクラスタに追加します。
+
[source, shell]
----
security certificate install -type server-ca -vserver <vserver_name>
----


. メディエーターを追加するには、システム マネージャーの保護 > 概要 > メディエーターに移動し、メディエーターの IP アドレス、ユーザー名 (API ユーザーのデフォルトは mediatoradmin)、パスワード、およびポート 31784 を入力します。
+
次の図は、クラスタ間ネットワーク インターフェイス、クラスタ ピア、メディエーター、および SVM ピアがすべて設定されていることを示しています。

+
image:hyperv-smas-010.png["入出力ダイアログまたは書かれたコンテンツを示す図"]





=== 対称アクティブ/アクティブ保護を構成する

整合性グループは、アプリケーション ワークロードの管理に便利です。ローカルとリモートの保護ポリシーを簡単に設定できるほか、一連のボリュームの特定の時点のクラッシュ整合性またはアプリケーション整合性Snapshotコピーを同時に作成できます。詳細については、link:https://docs.netapp.com/us-en/ontap/consistency-groups/index.html["一貫性グループの概要"] 。このセットアップでは均一な構成を使用します。

.均一な構成の手順
. 整合性グループを作成する際は、igroupを作成するホスト イニシエータを指定します。
. SnapMirrorを有効にするチェックボックスを選択し、AutomatedFailoverDuplex ポリシーを選択します。
. 表示されるダイアログ ボックスで、[イニシエータ グループを複製] チェックボックスをオンにして igroup を複製します。  「近接設定の編集」で、ホストの近接 SVM を設定します。
+
image:hyperv-smas-011.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

. 保存を選択
+
保護関係はソースと宛先の間で確立されます。

+
image:hyperv-smas-012.png["入出力ダイアログまたは書かれたコンテンツを示す図"]





=== クラスタフェイルオーバー検証テストを実行する

計画されたフェールオーバー テストを実行してクラスター検証チェックを行うことをお勧めします。両方のサイトの SQL データベースまたはクラスター化されたソフトウェアでは、テスト中もプライマリ サイトまたはミラー サイトは引き続きアクセスできる必要があります。

Hyper-V フェールオーバー クラスターの要件は次のとおりです。

* SnapMirrorアクティブ同期関係が同期されている必要があります。
* 中断を伴わない操作が進行中の場合、計画されたフェイルオーバーを開始することはできません。中断を伴わない操作には、ボリュームの移動、アグリゲートの再配置、ストレージのフェイルオーバーが含まれます。
* ONTAP Mediatorが設定されて接続され、クォーラムを構成している必要があります。
* VM 移行のプロセスを最適化するために、各サイトには同じ CPU ファミリに属する CPU プロセッサを搭載した少なくとも 2 つの Hyper-V クラスター ノードが必要です。  CPU は、ハードウェア支援による仮想化とハードウェアベースのデータ実行防止 (DEP) をサポートする CPU である必要があります。
* 回復力を確保するには、Hyper-V クラスター ノードは同じ Active Directory ドメイン メンバーである必要があります。
* 単一障害点を回避するために、Hyper-V クラスター ノードとNetAppストレージ ノードは冗長ネットワークで接続する必要があります。
* すべてのクラスター ノードから iSCSI、ファイバー チャネル、または SMB 3.0 プロトコル経由でアクセスできる共有ストレージ。




==== テストシナリオ

ホスト、ストレージ、またはネットワークでフェイルオーバーをトリガーする方法は多数あります。

image:hyperv-smas-013.png["入出力ダイアログまたは書かれたコンテンツを示す図"]

.Hyper-V のノードまたはサイトに障害が発生した
* ノード障害 フェールオーバー クラスター ノードは、障害が発生したノードのワークロードを引き継ぐことができます。このプロセスはフェールオーバーと呼ばれます。アクション: Hyper-V ノードの電源をオフにします。 期待される結果: クラスター内の他のノードがワークロードを引き継ぎます。  VM は他のノードに移行されます。
* 1 つのサイト障害 サイト全体を障害状態にして、プライマリ サイトのミラー サイトへのフェールオーバーをトリガーすることもできます。アクション: 1 つのサイトの両方の Hyper-V ノードをオフにします。期待される結果: SnapMirrorアクティブ同期対称アクティブ/アクティブは双方向レプリケーションを使用して IO をローカルに提供し、RPO と RTO がゼロでワークロードに影響を与えないため、プライマリ サイトの VM はミラー サイトの Hyper-V クラスターに移行されます。


.1つのサイトでのストレージ障害
* プライマリ サイトの SVM を停止します。アクション: iSCSI SVM を停止します。期待される結果: Hyper-V プライマリ クラスターはすでにミラー サイトに接続されており、 SnapMirrorアクティブ同期対称アクティブ/アクティブにより、RPO と RTO がゼロでワークロードに影響はありません。


.成功基準
テスト中は、次の点に注意してください。

* クラスターの動作を観察し、サービスが残りのノードに転送されていることを確認します。
* エラーやサービスの中断がないか確認してください。
* クラスターがストレージ障害を処理して動作を継続できることを確認します。
* データベース データに引き続きアクセスでき、サービスが継続して動作していることを確認します。
* データベースのデータの整合性が維持されていることを確認します。
* 特定のアプリケーションがユーザーに影響を与えずに別のノードにフェールオーバーできることを検証します。
* フェイルオーバー中およびフェイルオーバー後にクラスターが負荷を分散し、パフォーマンスを維持できることを確認します。




== まとめ

SnapMirrorアクティブ同期は、MSSQL や Oracle などのマルチサイト アプリケーション データを両方のサイトでアクティブにアクセスし、同期するのに役立ちます。障害が発生した場合、アプリケーションはデータの損失やアクセスの損失なく、残りのアクティブ サイトに直ちにリダイレクトされます。
