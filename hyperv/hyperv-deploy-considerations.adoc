---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-considerations.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, consideration 
summary: このソリューションは、 NetAppストレージにHyper-Vを導入するために必要な手順を提供します。 
---
= ONTAPストレージ システムを使用した Microsoft Hyper-V の導入ガイドライン
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ONTAPストレージを使用して Microsoft Hyper-V を導入する際に最適なパフォーマンスと信頼性を確保するには、ワークロードの互換性、ストレージのサイズ設定、VM リソースの割り当てなどの要素を考慮してください。互換性チェックには、Hyper-V 環境内でのスムーズな操作を確保するために、OS バージョン、アプリケーション、データベース、および既存のカスタマイズを含める必要があります。



== ストレージの適切なサイズ設定

ワークロードを展開したり、既存のハイパーバイザーから移行したりする前に、ワークロードが必要なパフォーマンスを満たすサイズになっていることを確認してください。これは、CPU (使用済み/プロビジョニング済み)、メモリ (使用済み/プロビジョニング済み)、ストレージ (プロビジョニング済み/使用済み)、ネットワーク スループットとレイテンシの統計情報、および読み取り/書き込み IOP、スループット、ブロック サイズの集計を収集する各 VM のパフォーマンス データを収集することで簡単に実行できます。これらのパラメータは、デプロイメントを成功させ、ストレージ アレイとワークロード ホストのサイズを正しく設定するために必須です。

*注*: Hyper-V および関連ワークロードのストレージのサイズを決定するときは、IOPS と容量を計画してください。

*注*: I/O 負荷の高い VM や、大量のリソースと容量を必要とする VM の場合は、OS ディスクとデータ ディスクを分離します。オペレーティング システムとアプリケーション バイナリは頻繁に変更されず、ボリューム クラッシュの一貫性は許容範囲内です。

*注*: 高パフォーマンスのデータ ディスクには、VHD を使用するよりも、ゲスト接続ストレージ (ゲスト内ストレージとも呼ばれます) を使用してください。これにより、クローン作成プロセスも容易になります。



== 仮想マシンのパフォーマンスを向上

最適なパフォーマンスを得るために、適切な量の RAM と vCPU を選択し、複数のディスクを単一の仮想 SCSI コントローラに接続します。展開用の仮想ディスクの主な選択肢としては、固定 VHDx の使用が依然として推奨されており、どのタイプの VHDX 仮想ディスクの使用にも制限はありません。

*注意*: 使用されない不要な役割を Windows Server にインストールしないでください。

*注*: SCSI コントローラから VM をロードできる仮想マシンの世代として Gen2 を選択してください。これは、ブート レベルの VMBUS および VSP/VSC アーキテクチャに基づいており、全体的な VM パフォーマンスが大幅に向上します。

*注意*: VM のパフォーマンスに悪影響を与えるため、頻繁にチェックポイントを作成しないでください。



== SMB3.0の設計と考察

SMB 3.0ファイル共有は、Hyper-Vの共有ストレージとして使用できます。ONTAPは、 Hyper-VのSMB共有を介した無停止運用をサポートしています。Hyper-Vは、SMBファイル共有を使用して、構成ファイル、スナップショットファイル、仮想ハードディスク（VHD）ファイルなどの仮想マシンファイルを保存できます。  Hyper-VのSMB3.0ベースの共有には、専用のONTAP CIFS SVMを使用してください。仮想マシンファイルの保存に使用するボリュームは、NTFSセキュリティ形式のボリュームで作成する必要があります。  Hyper-V ホストとNetAppアレイ間の接続は、10GB ネットワークが利用可能な場合はそのネットワークで行うことをお勧めします。  1GB ネットワーク接続の場合、 NetApp複数の 1GB ポートで構成されるインターフェイス グループを作成することをお勧めします。  SMB マルチチャネルを提供する各 NIC を専用の IP サブネットに接続し、各サブネットがクライアントとサーバーの間で単一のパスを提供するようにします。

*要点*

* ONTAP SVMでSMBマルチチャネルを有効にする
* ONTAP CIFS SVM では、クラスタ内の各ノードに少なくとも 1 つのデータ LIF が必要です。
* 使用される共有は、継続的に利用可能なプロパティ セットを使用して構成する必要があります。
* ONTAP One は、すべてのAFF (A シリーズおよび C シリーズ)、All-SAN Array (ASA)、およびFASシステムに含まれるようになりました。したがって、個別のライセンスは必要ありません。
* 共有VHDxの場合は、ゲスト接続されたiSCSI LUNを使用します。


*注*: ODX はサポートされており、プロトコル間で動作します。ファイル共有と iSCSI または FCP 接続 LUN 間のデータのコピーでも ODX が使用されます。

*注意*: クラスター内のノードの時間設定もそれに応じて設定する必要があります。  NetApp CIFS サーバーが Windows Active Directory (AD) ドメインに参加する必要がある場合は、ネットワーク タイム プロトコル (NTP) を使用する必要があります。

*注意*: 大きな MTU 値は CIFS サーバーを通じて有効にする必要があります。パケット サイズが小さいとパフォーマンスが低下する可能性があります。



== SMBボリュームのプロビジョニング

. ストレージ仮想マシン（SVM）で必要なCIFSサーバオプションが有効になっていることを確認します。
. 以下のオプションをtrueに設定する必要があります: smb2-enabled smb3-enabled copy-offload-enabled shadowcopy-enabled is-multichannel-enabled is-large-mtu-enabled
+
image:hyperv-deploy-003.png["SMB列設定の画像"]

. ストレージ仮想マシン (SVM) 上に NTFS データボリュームを作成し、Hyper-V で使用するために継続的に利用可能な共有を構成します。
+
image:hyperv-deploy-004.png["NTFSデータボリューム設定の画像"]

+
*注意*: 構成で使用されるボリュームが NTFS セキュリティ スタイルのボリュームとして作成されていない限り、Hyper-V over SMB の無停止操作は正しく機能しません。

. 継続的な可用性を有効にし、共有の NTFS アクセス許可を構成して、フル コントロールを持つ Hyper-V ノードを含めます。
+
image:hyperv-deploy-005.png["NTFS権限設定の画像"]



詳細なベストプラクティスのガイダンスについては、link:https://docs.netapp.com/us-en/ontap-apps-dbs/microsoft/win_overview.html["Hyper-V の導入ガイドラインとベストプラクティス"] 。

詳細については、link:https://docs.netapp.com/us-en/ontap/smb-hyper-v-sql/server-volume-requirements-hyper-v-concept.html["Hyper-V over SMB用のSMBサーバとボリュームの要件"] 。



== ブロックプロトコルの設計と考察

*要点*

* 複数のパスを管理するには、ホスト上でマルチパス (MPIO) を使用します。データ移動操作を容易にするため、または追加の I/O リソースを活用するために、必要に応じてさらにパスを作成しますが、ホスト OS がサポートできるパスの最大数を超えないようにしてください。
* LUN にアクセスするホストにホスト ユーティリティ キットをインストールします。
* 少なくとも 8 つのボリュームを作成します。


*注意*: ボリュームごとに 1 つの LUN を使用するため、LUN と CSV の比率は 1:1 になります。

* SVM には、iSCSI またはファイバ チャネルを使用してデータを提供するすべてのストレージ コントローラ上のイーサネット ネットワークまたはファイバ チャネル ファブリックごとに 1 つの LIF が必要です。
* FCP または iSCSI を使用してデータを提供する SVM には、SVM 管理インターフェイスが必要です。




== iSCSIボリュームのプロビジョニング

iSCSI ボリュームをプロビジョニングするには、次の前提条件が満たされていることを確認してください。

* ストレージ仮想マシン (SVM) では、iSCSI プロトコルが有効になっており、適切な論理インターフェイス (LIF) が作成されている必要があります。
* 指定されたアグリゲートには、LUN を格納するのに十分な空き領域が必要です。


*注*: デフォルトでは、 ONTAP は選択的 LUN マップ (SLM) を使用して、LUN を所有するノードとその高可用性 (HA) パートナー上のパスを介してのみ LUN にアクセスできるようにします。

* LUN がクラスター内の別のノードに移動された場合に備えて、すべてのノード上のすべての iSCSI LIF を LUN モビリティ用に設定します。


*手順*

. System Manager を使用して、LUN ウィンドウに移動します (同じ操作にONTAP CLI を使用できます)。
. [Create]をクリックします。
. LUN を作成する指定の SVM を参照して選択すると、LUN の作成ウィザードが表示されます。
. [全般プロパティ] ページで、Hyper-V 仮想マシンの仮想ハード ディスク (VHD) を含む LUN に対して [Hyper-V] を選択します。
+
image:hyperv-deploy-006.png["Hyper-V LUN 作成の全般プロパティ ページの画像"]

. <その他のオプションをクリック> LUN コンテナ ページで、既存のFlexVol volumeを選択します。選択しない場合は、新しいボリュームが作成されます。
. <その他のオプションをクリック> [イニシエーター マッピング] ページで [イニシエーター グループの追加] をクリックし、[全般] タブに必要な情報を入力してから、[イニシエーター] タブでホストの iSCSI イニシエーター ノード名を入力します。
. 詳細を確認し、「完了」をクリックしてウィザードを完了します。


LUN が作成されたら、フェールオーバー クラスター マネージャーに移動します。ディスクを CSV に追加するには、ディスクをクラスターの使用可能なストレージ グループに追加し (まだ追加されていない場合)、次にディスクをクラスター上の CSV に追加する必要があります。

*注*: フェールオーバー クラスタリングでは、CSV 機能がデフォルトで有効になっています。

*使用可能なストレージにディスクを追加する:*

. フェールオーバー クラスター マネージャーのコンソール ツリーで、クラスターの名前を展開し、記憶域を展開します。
. [ディスク] を右クリックし、[ディスクの追加] を選択します。フェールオーバー クラスターで使用するために追加できるディスクを示すリストが表示されます。
. 追加するディスクを選択し、[OK] を選択します。
. これで、ディスクが使用可能なストレージ グループに割り当てられました。
. 完了したら、使用可能な記憶域に割り当てられたディスクを選択し、選択内容を右クリックして、[クラスターの共有ボリュームに追加] を選択します。
+
image:hyperv-deploy-007.png["クラスター共有ボリュームへの追加インターフェースの画像"]

. これで、ディスクはクラスター内のクラスター共有ボリューム グループに割り当てられました。ディスクは、%SystemDrive%ClusterStorage フォルダーの下の番号付きボリューム (マウント ポイント) として各クラスター ノードに公開されます。ボリュームは CSVFS ファイル システムに表示されます。


詳細については、link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/failover-cluster-csvs#add-a-disk-to-csv-on-a-failover-cluster["フェールオーバークラスターでクラスター共有ボリュームを使用する"] 。

*高可用性の仮想マシンを作成する:*

高可用性の仮想マシンを作成するには、次の手順に従います。

. フェールオーバー クラスター マネージャーで、必要なクラスターを選択または指定します。クラスターの下のコンソール ツリーが展開されていることを確認します。
. [役割]をクリックします。
. [操作] ウィンドウで、[仮想マシン] をクリックし、[新しい仮想マシン] をクリックします。新しい仮想マシン ウィザードが表示されます。[Next]をクリックします。
. [名前と場所の指定] ページで、仮想マシンの名前 (nimdemo など) を指定します。  「仮想マシンを別の場所に保存する」をクリックし、完全なパスを入力するか、「参照」をクリックして共有ストレージに移動します。
. 物理ネットワーク アダプタに関連付けられている仮想スイッチにメモリを割り当て、ネットワーク アダプタを構成します。
. [仮想ハード ディスクの接続] ページで、[仮想ハード ディスクの作成] をクリックします。
. [インストール オプション] ページで、[ブート CD/DVD-ROM からオペレーティング システムをインストールする] をクリックします。  [メディア] でメディアの場所を指定し、[完了] をクリックします。
. 仮想マシンが作成されます。フェールオーバー クラスター マネージャーの高可用性ウィザードは、仮想マシンを高可用性用に自動的に構成します。




== ODX機能を使用した仮想ディスクの高速プロビジョニング

ONTAPの ODX 機能を使用すると、 ONTAPストレージ システムによってホストされているマスター VHDX ファイルをコピーするだけで、マスター VHDX のコピーを作成できます。 ODX 対応コピーではネットワーク ワイヤ上にデータが送信されないため、コピー プロセスはNetAppストレージ側で実行され、その結果、最大 6 ～ 8 倍の速度が得られます。高速プロビジョニングに関する一般的な考慮事項には、ファイル共有に保存されたマスター Sysprep イメージと、Hyper-V ホスト マシンによって開始される定期的なコピー プロセスが含まれます。

*注*: ONTAP は、SMB プロトコルと SAN プロトコルの両方で ODX をサポートしています。

*注*: Hyper-V で ODX コピー オフロード パススルーの使用例を活用するには、ゲスト オペレーティング システムが ODX をサポートし、ゲスト オペレーティング システムのディスクが ODX をサポートするストレージ (SMB または SAN) によってバックアップされた SCSI ディスクである必要があります。ゲスト オペレーティング システムのディスクがIDEディスクの場合、ODXのパススルーはサポートされません。



== パフォーマンスの最適化

CSV あたりの推奨 VM 数は主観的ですが、各 CSV または SMB ボリュームに配置できる最適な VM 数はさまざまな要因によって決まります。ほとんどの管理者は容量のみを考慮しますが、VHDx に送信される同時 I/O の量は、全体的なパフォーマンスにとって最も重要な要素の 1 つです。パフォーマンスを制御する最も簡単な方法は、各 CSV または共有に配置される仮想マシンの数を制限することです。同時仮想マシンの I/O パターンによって CSV または共有に送信されるトラフィックが多すぎる場合、ディスク キューがいっぱいになり、待機時間が長くなります。



== SMBボリュームとCSVのサイズ設定

ボトルネックを回避するために、ソリューションがエンドツーエンドで適切なサイズになっていることを確認してください。また、Hyper-V VM ストレージ用にボリュームを作成する場合は、必要なサイズを超えないボリュームを作成することがベスト プラクティスです。ボリュームのサイズを適切に設定すると、CSV 上に誤って過剰な数の仮想マシンを配置することが防止され、リソース競合の可能性が減少します。各クラスター共有ボリューム (CSV) は、1 つまたは複数の VM をサポートします。 CSV に配置する VM の数は、ワークロードとビジネス設定、およびスナップショットやレプリケーションなどのONTAPストレージ機能の使用方法によって決まります。ほとんどの展開シナリオでは、複数の VM を CSV に配置することが適切な出発点となります。パフォーマンスとデータ保護の要件を満たすために、特定のユースケースに合わせてこのアプローチを調整します。

ボリュームと VHDx のサイズは簡単に増やすことができるため、VM に追加の容量が必要な場合でも、CSV のサイズを必要以上に大きくする必要はありません。 CSV サイズを拡張するには Diskpart を使用できますが、より簡単な方法としては、新しい CSV を作成し、必要な VM を新しい CSV に移行することです。最適なパフォーマンスを得るには、暫定的な対策として CSV のサイズを増やすのではなく、CSV の数を増やすことがベスト プラクティスです。



== 移住

現在の市場状況で最も一般的なユースケースの 1 つは移行です。顧客は VMM Fabric またはその他のサードパーティ移行ツールを使用して VM を移行できます。これらのツールはホスト レベルのコピーを使用してソース プラットフォームから宛先プラットフォームにデータを移動しますが、移行範囲内の仮想マシンの数によっては時間がかかる場合があります。

このようなシナリオでONTAPを使用すると、ホストベースの移行プロセスを使用するよりも迅速な移行が可能になります。  ONTAP を使用すると、VM をあるハイパーバイザーから別のハイパーバイザー (この場合は ESXi から Hyper-V) に迅速に移行することもできます。 NetAppストレージでは、あらゆるサイズの VMDK を数秒で VHDx に変換できます。これが PowerShell の方法です。NetApp FlexCloneテクノロジーを活用して、VM ハード ディスクを迅速に変換します。また、ターゲット VM と宛先 VM の作成と構成も処理します。

このプロセスは、ダウンタイムを最小限に抑え、ビジネスの生産性を向上させるのに役立ちます。また、ライセンス コスト、ロックイン、単一ベンダーへの拘束を削減することで、選択肢と柔軟性も提供します。これは、VM ライセンス コストを最適化し、IT 予算を拡張したい組織にとっても有益です。

次のビデオでは、仮想マシンを VMware ESX から Hyper-V に移行するプロセスについて説明します。

.ESX から Hyper-V へのゼロタッチ移行
video::f4bd0e96-9517-465a-be53-b16d00e305fe[panopto]
FlexcloneとPowerShellを使用した移行の詳細については、link:hyperv-deploy-script.html["移行用の PowerShell スクリプト"] 。
